/* vi: set ts=4 sw=4 et : */
/* vim: set comments= cinoptions=\:0,t0,+8,c4,C1 : */

struct cb_check_stacktrace_s {
    unsigned int idx;
    const xmlerr_loc_t *ptr;
    const xmlerr_loc_t *end;
    bool failed;
};

static void
cb_check_stacktrace(void *arg, const xmlerr_loc_t *loc)
{
    struct cb_check_stacktrace_s *cba = arg;

    printf("  [%02u] %s:%u:%u", cba->idx, loc->src, loc->line, loc->pos);
    if (cba->ptr >= cba->end) {
        printf(" [UNEXPECTED]\n");
        cba->failed = true;
    }
    else {
        if (strcmp(cba->ptr->src, loc->src)
                || cba->ptr->line != loc->line
                || cba->ptr->pos != loc->pos) {
            printf(" [EXPECTED %s:%u:%u]\n", cba->ptr->src, cba->ptr->line, cba->ptr->pos);
            cba->failed = true;
        }
        else {
            printf("\n");
        }
        cba->ptr++;
    }
    cba->idx++;
}

static result_t
check_stacktrace(xml_reader_t *h, xml_reader_cbparam_t *e, const void *arg)
{
    static const xmlerr_loc_t expected_stack[] = {
        { "entity(e1)", 1, 5 },
        { "entity(e2)", 1, 8 },
        { "entity(e3)", 1, 8 },
        { "stack-test.xml", 6, 8 },
    };
    struct cb_check_stacktrace_s cba;

    if (e->cbtype != XML_READER_CB_ETAG || xml_reader_token_isset(&e->tag.name)) {
        // Only interested in the innermost event, which is the only empty tag
        return PASS;
    }
    cba.idx = 0;
    cba.ptr = expected_stack;
    cba.end = expected_stack + sizeofarray(expected_stack);
    cba.failed = false;
    printf("Stack trace:\n");
    xml_reader_stack(h, cb_check_stacktrace, &cba);
    return cba.failed ? FAIL : PASS;
}

static const testcase_t testcases_api[] = {
    {
        TC("Stack trace of parser state"),
        .input = "stack-test.xml",
        .checkevt = check_stacktrace,
        .events = (const xml_reader_cbparam_t[]){
            EV(DTD_BEGIN,
                    LOC("stack-test.xml", 1, 1),
                    .root = TOK("a"),
            ),
            EV(ENTITY_DEF,
                    LOC("stack-test.xml", 2, 1),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("e1"),
                    .text = TOK("<d/>"),
            ),
            EV(ENTITY_DEF,
                    LOC("stack-test.xml", 3, 1),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("e2"),
                    .text = TOK("<c>&e1;</c>"),
            ),
            EV(ENTITY_DEF,
                    LOC("stack-test.xml", 4, 1),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("e3"),
                    .text = TOK("<b>&e2;</b>"),
            ),
            E0(DTD_END_INTERNAL,
                    LOC("stack-test.xml", 5, 1)
            ),
            E0(DTD_END,
                    LOC("stack-test.xml", 5, 3)
            ),
            EV(STAG,
                    LOC("stack-test.xml", 6, 1),
                    .name = TOK("a"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("stack-test.xml", 6, 4),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("e3"),
            ),
            EV(STAG,
                    LOC("entity(e3)", 1, 1),
                    .name = TOK("b"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("entity(e3)", 1, 4),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("e2"),
            ),
            EV(STAG,
                    LOC("entity(e2)", 1, 1),
                    .name = TOK("c"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("entity(e2)", 1, 4),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("e1"),
            ),
            EV(STAG,
                    LOC("entity(e1)", 1, 1),
                    .name = TOK("d"),
            ),
            E0(ETAG,
                    LOC("entity(e1)", 1, 3)
            ),
            EV(ENTITY_PARSE_END,
                    LOC("entity(e2)", 1, 4),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("e1"),
            ),
            EV(ETAG,
                    LOC("entity(e2)", 1, 8),
                    .name = TOK("c"),
            ),
            EV(ENTITY_PARSE_END,
                    LOC("entity(e3)", 1, 4),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("e2"),
            ),
            EV(ETAG,
                    LOC("entity(e3)", 1, 8),
                    .name = TOK("b"),
            ),
            EV(ENTITY_PARSE_END,
                    LOC("stack-test.xml", 6, 4),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("e3"),
            ),
            EV(ETAG,
                    LOC("stack-test.xml", 6, 8),
                    .name = TOK("a"),
            ),
            END,
        },
    },
};

// Set an encoding that cannot be autodetected. Dummy loader that always provides
// a simple <a/> file.
#define XORKEY  0xA5

static size_t
in_XOR(void *baton, const uint8_t *begin, const uint8_t *end,
                ucs4_t **pout, ucs4_t *end_out)
{
    const uint8_t *ptr = begin;
    ucs4_t *out = *pout;

    while (ptr < end && out < end_out) {
        *out = ucs4_fromlocal(*ptr ^ XORKEY);
        out++;
        ptr++;
    }
    *pout = out;
    return ptr - begin;
}

static const encoding_t enc_XOR = {
    .name = "XOR_ENCODING",
    .form = ENCODING_FORM_UTF8,
    .endian = ENCODING_E_ANY,
    .baton_sz = 0,
    .sigs = NULL,
    .nsigs = 0,
    .in = in_XOR,
    .in_clean = NULL,
};
ENCODING_REGISTER(enc_XOR);

static void
loader_XORENC(xml_reader_t *h, void *arg, const xml_loader_info_t *loader_info)
{
    static const char * const doc = "<a/>";
    size_t len = strlen(doc);
    const char *s;
    void *begin, *end;
    uint8_t *ptr, *pend;
    strbuf_t *buf;

    buf = strbuf_new(len);
    strbuf_wptr(buf, &begin, &end);
    for (ptr = begin, pend = end, s = doc; ptr < pend; ptr++, s++) {
        *ptr = *(const unsigned char *)s ^ XORKEY;
    }
    strbuf_wadvance(buf, len);
    xml_reader_add_parsed_entity(h, buf, loader_info->system_id, arg);
}

static void
set_loader_XORENC(xml_reader_t *h)
{
    xml_reader_set_loader(h, loader_XORENC, DECONST("XOR_ENCODING"));
}

static void
set_loader_XORENC_BAD(xml_reader_t *h)
{
    xml_reader_set_loader(h, loader_XORENC, DECONST("GNIDOCNE_ROX"));
}


// Long encoding name
#define VERY_LONG_ENCODING \
        "INVALID_ENCODING_WITH_A_VERY_LONG_NAME_THAT_IS_GOING_TO_SPAN" \
        "_A_FEW_LINES_AND_PROBABLY_REQUIRE_REALLOCATION_OF_THE_BUFFER"

static const testcase_t testcases_encoding[] = {
    {
        TC("No declaration in UTF-8, with BOM"),
        .input = "simple-no-decl.xml",
        .use_bom = true,
        .events = (const xml_reader_cbparam_t[]){
            EV(STAG,
                    LOC("simple-no-decl.xml", 1, 1),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("simple-no-decl.xml", 1, 3)
            ),
            END,
        },
    },
    {
        TC("No declaration in UTF-8, without BOM"),
        .input = "simple-no-decl.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(STAG,
                    LOC("simple-no-decl.xml", 1, 1),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("simple-no-decl.xml", 1, 3)
            ),
            END,
        },
    },
    {
        TC("No declaration in UTF-16BE, with BOM"),
        .input = "simple-no-decl.xml",
        .use_bom = true,
        .encoding = "UTF-16BE",
        .events = (const xml_reader_cbparam_t[]){
            EV(STAG,
                    LOC("simple-no-decl.xml", 1, 1),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("simple-no-decl.xml", 1, 3)
            ),
            END,
        },
    },
    {
        TC("No declaration in UTF-16BE, without BOM"),
        .input = "simple-no-decl.xml",
        .encoding = "UTF-16BE",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("simple-no-decl.xml", 1, 1),
                    .info = XMLERR(ERROR, XML, ENCODING_ERROR),
                    .msg = "No external encoding information, no encoding "
                    "in XMLDecl, content in UTF-16BE encoding",
            ),
            EV(STAG,
                    LOC("simple-no-decl.xml", 1, 1),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("simple-no-decl.xml", 1, 3)
            ),
            END,
        },
    },
    {
        TC("No declaration in UTF-16LE, with BOM"),
        .input = "simple-no-decl.xml",
        .use_bom = true,
        .encoding = "UTF-16LE",
        .events = (const xml_reader_cbparam_t[]){
            EV(STAG,
                    LOC("simple-no-decl.xml", 1, 1),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("simple-no-decl.xml", 1, 3)
            ),
            END,
        },
    },
    {
        TC("No declaration in UTF-16LE, without BOM"),
        .input = "simple-no-decl.xml",
        .encoding = "UTF-16LE",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("simple-no-decl.xml", 1, 1),
                    .info = XMLERR(ERROR, XML, ENCODING_ERROR),
                    .msg = "No external encoding information, no encoding "
                    "in XMLDecl, content in UTF-16LE encoding",
            ),
            EV(STAG,
                    LOC("simple-no-decl.xml", 1, 1),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("simple-no-decl.xml", 1, 3)
            ),
            END,
        },
    },
    {
        TC("Simple XML in UTF-8, with BOM"),
        .input = "simple-utf8.xml",
        .use_bom = true,
        .events = (const xml_reader_cbparam_t[]){
            EV(XMLDECL,
                    LOC("simple-utf8.xml", 2, 8),
                    .encoding = "UTF-8",
                    .standalone = XML_INFO_STANDALONE_NO_VALUE,
                    .version = XML_INFO_VERSION_1_0,
            ),
            EV(STAG,
                    LOC("simple-utf8.xml", 3, 9),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("simple-utf8.xml", 3, 11)
            ),
            END,
        },
    },
    {
        TC("Simple XML in UTF-8, without BOM"),
        .input = "simple-utf8.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(XMLDECL,
                    LOC("simple-utf8.xml", 2, 8),
                    .encoding = "UTF-8",
                    .standalone = XML_INFO_STANDALONE_NO_VALUE,
                    .version = XML_INFO_VERSION_1_0,
            ),
            EV(STAG,
                    LOC("simple-utf8.xml", 3, 9),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("simple-utf8.xml", 3, 11)
            ),
            END,
        },
    },
    {
        TC("Simple XML in UTF-16 (BE, with BOM)"),
        .input = "simple-utf16.xml",
        .use_bom = true,
        .encoding = "UTF-16BE",
        .events = (const xml_reader_cbparam_t[]){
            EV(XMLDECL,
                    LOC("simple-utf16.xml", 1, 38),
                    .encoding = "UTF-16",
                    .standalone = XML_INFO_STANDALONE_NO_VALUE,
                    .version = XML_INFO_VERSION_1_0,
            ),
            EV(STAG,
                    LOC("simple-utf16.xml", 2, 1),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("simple-utf16.xml", 2, 3)
            ),
            END,
        },
    },
    {
        TC("Simple XML in UTF-16 (LE, with BOM)"),
        .input = "simple-utf16.xml",
        .use_bom = true,
        .encoding = "UTF-16LE",
        .events = (const xml_reader_cbparam_t[]){
            EV(XMLDECL,
                    LOC("simple-utf16.xml", 1, 38),
                    .encoding = "UTF-16",
                    .standalone = XML_INFO_STANDALONE_NO_VALUE,
                    .version = XML_INFO_VERSION_1_0,
            ),
            EV(STAG,
                    LOC("simple-utf16.xml", 2, 1),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("simple-utf16.xml", 2, 3)
            ),
            END,
        },
    },
    {
        TC("Simple XML in UTF-16BE, without BOM"),
        .input = "simple-utf16.xml",
        .encoding = "UTF-16BE",
        .events = (const xml_reader_cbparam_t[]){
            EV(XMLDECL,
                    LOC("simple-utf16.xml", 1, 38),
                    .encoding = "UTF-16",
                    .standalone = XML_INFO_STANDALONE_NO_VALUE,
                    .version = XML_INFO_VERSION_1_0,
            ),
            EV(MESSAGE,
                    LOC("simple-utf16.xml", 1, 40),
                    .info = XMLERR(ERROR, XML, ENCODING_ERROR),
                    .msg = "UTF-16 encoding without byte-order mark",
            ),
            EV(STAG,
                    LOC("simple-utf16.xml", 2, 1),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("simple-utf16.xml", 2, 3)
            ),
            END,
        },
    },
    {
        TC("Simple XML in UTF-16LE, without BOM"),
        .input = "simple-utf16.xml",
        .encoding = "UTF-16LE",
        .events = (const xml_reader_cbparam_t[]){
            EV(XMLDECL,
                    LOC("simple-utf16.xml", 1, 38),
                    .encoding = "UTF-16",
                    .standalone = XML_INFO_STANDALONE_NO_VALUE,
                    .version = XML_INFO_VERSION_1_0,
            ),
            EV(MESSAGE,
                    LOC("simple-utf16.xml", 1, 40),
                    .info = XMLERR(ERROR, XML, ENCODING_ERROR),
                    .msg = "UTF-16 encoding without byte-order mark",
            ),
            EV(STAG,
                    LOC("simple-utf16.xml", 2, 1),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("simple-utf16.xml", 2, 3)
            ),
            END,
        },
    },
    {
        TC("Simple XML in UTF-16BE, invalid transport encoding"),
        .input = "simple-utf16.xml",
        .use_bom = true,
        .encoding = "UTF-16BE",
        .transport_encoding = "INVALID_ENCODING",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("simple-utf16.xml", 1, 1),
                    .info = XMLERR(ERROR, XML, ENCODING_ERROR),
                    .msg = "Unsupported transport encoding 'INVALID_ENCODING'",
            ),
            EV(ENTITY_NOT_LOADED,
                    NOLOC,
                    .type = XML_READER_REF_DOCUMENT,
                    .system_id = TOK("simple-utf16.xml"),
            ),
            END,
        },
    },
    {
        TC("Simple XML with invalid encoding declaration"),
        .input = "simple-invalid-encoding.xml",
        .use_bom = true,
        .events = (const xml_reader_cbparam_t[]){
            EV(XMLDECL,
                    LOC("simple-invalid-encoding.xml", 1, 152),
                    .encoding = VERY_LONG_ENCODING,
                    .standalone = XML_INFO_STANDALONE_NO_VALUE,
                    .version = XML_INFO_VERSION_1_0,
            ),
            EV(MESSAGE,
                    LOC("simple-invalid-encoding.xml", 1, 154),
                    .info = XMLERR(ERROR, XML, ENCODING_ERROR),
                    .msg = "Unsupported declared encoding '" VERY_LONG_ENCODING "'",
            ),
            EV(STAG,
                    LOC("simple-invalid-encoding.xml", 2, 1),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("simple-invalid-encoding.xml", 2, 3)
            ),
            END,
        },
    },
    {
        TC("Incompatible encodings from transport layer and from autodetection"),
        .input = "simple-utf8.xml",
        .use_bom = true,
        .transport_encoding = "UTF-16BE",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("simple-utf8.xml", 1, 1),
                    .info = XMLERR(ERROR, XML, ENCODING_ERROR),
                    .msg = "Transport encoding 'UTF-16BE' incompatible with auto-detected 'UTF-8'",
            ),
            EV(ENTITY_NOT_LOADED,
                    NOLOC,
                    .type = XML_READER_REF_DOCUMENT,
                    .system_id = TOK("simple-utf8.xml"),
            ),
            END,
        },
    },
    {
        TC("Incompatible encodings from autodetection and from declaration"),
        .input = "simple-utf16.xml",
        .use_bom = true,
        .events = (const xml_reader_cbparam_t[]){
            EV(XMLDECL,
                    LOC("simple-utf16.xml", 1, 38),
                    .encoding = "UTF-16",
                    .standalone = XML_INFO_STANDALONE_NO_VALUE,
                    .version = XML_INFO_VERSION_1_0,
            ),
            EV(MESSAGE,
                    LOC("simple-utf16.xml", 1, 40),
                    .info = XMLERR(ERROR, XML, ENCODING_ERROR),
                    .msg = "Declared encoding 'UTF-16' incompatible with current encoding 'UTF-8'",
            ),
            EV(STAG,
                    LOC("simple-utf16.xml", 2, 1),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("simple-utf16.xml", 2, 3)
            ),
            END,
        },
    },
    {
        TC("Partial character at end of input"),
        .input = "partial-chars.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(STAG,
                    LOC("partial-chars.xml", 1, 1),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("partial-chars.xml", 1, 3)
            ),
            EV(MESSAGE,
                    LOC("partial-chars.xml", 3, 2),
                    .info = XMLERR(ERROR, XML, ENCODING_ERROR),
                    .msg = "Partial character at the end of input",
            ),
            END,
        },
    },
    {
        TC("Invalid character at top level"),
        .input = "invalid-chars-top-level.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(STAG,
                    LOC("invalid-chars-top-level.xml", 1, 1),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("invalid-chars-top-level.xml", 1, 3)
            ),
            EV(MESSAGE,
                    LOC("invalid-chars-top-level.xml", 1, 5),
                    .info = XMLERR(ERROR, XML, P_document),
                    .msg = "Invalid content at root level",
            ),
            EV(COMMENT,
                    LOC("invalid-chars-top-level.xml", 2, 1),
                    .text = TOK(" Comment ")
            ),
            END,
        },
    },
    {
        TC("Encoding cannot be automatically detected but supplied by loader"),
        .input = "fakefile.xml",
        .setup = set_loader_XORENC,
        .events = (const xml_reader_cbparam_t[]){
            EV(STAG,
                    LOC("fakefile.xml", 1, 1),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("fakefile.xml", 1, 3)
            ),
            END,
        },
    },
    {
        TC("Encoding cannot be automatically detected, wrong encoding supplied by loader"),
        .input = "fakefile.xml",
        .setup = set_loader_XORENC_BAD,
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("fakefile.xml", 1, 1),
                    .info = XMLERR(ERROR, XML, ENCODING_ERROR),
                    .msg = "Unsupported transport encoding 'GNIDOCNE_ROX'",
            ),
            EV(ENTITY_NOT_LOADED,
                    NOLOC,
                    .type = XML_READER_REF_DOCUMENT,
                    .system_id = TOK("fakefile.xml"),
            ),
            END,
        },
    },
};

static const testcase_t testcases_xmldecl[] = {
    {
        TC("No document entity"),
        .input = "nonexistent.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC(NULL, 0, 0),
                    .info = XMLERR(ERROR, XML, ENTITY_LOAD_FAILURE),
                    .msg = "Entity failed to load: nonexistent.xml",
            ),
            EV(ENTITY_NOT_LOADED,
                    LOC(NULL, 0, 0),
                    .type = XML_READER_REF_DOCUMENT,
                    .system_id = TOK("nonexistent.xml"),
            ),
            END,
        },
    },
    {
        TC("Empty file"),
        .input = "empty.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("empty.xml", 1, 1),
                    .info = XMLERR(ERROR, XML, P_document),
                    .msg = "No root element",
            ),
            END,
        },
    },
    {
        TC("Truncated declaration #1"),
        .input = "truncated-decl1.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("truncated-decl1.xml", 1, 21),
                    .info = XMLERR(ERROR, XML, P_XMLDecl),
                    .msg = "Malformed XMLDecl: unexpected pseudo-attribute",
            ),
            EV(MESSAGE,
                    LOC("truncated-decl1.xml", 1, 25),
                    .info = XMLERR(ERROR, XML, P_XMLDecl),
                    .msg = "Expected string: '='",
            ),
            EV(ENTITY_NOT_LOADED,
                    NOLOC,
                    .type = XML_READER_REF_DOCUMENT,
                    .system_id = TOK("truncated-decl1.xml"),
            ),
            END,
        },
    },
    {
        TC("Truncated declaration #2"),
        .input = "truncated-decl2.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("truncated-decl2.xml", 1, 30),
                    .info = XMLERR(ERROR, XML, P_XMLDecl),
                    .msg = "Unterminated literal",
            ),
            EV(ENTITY_NOT_LOADED,
                    NOLOC,
                    .type = XML_READER_REF_DOCUMENT,
                    .system_id = TOK("truncated-decl2.xml"),
            ),
            END,
        },
    },
    {
        TC("Truncated declaration #3"),
        .input = "truncated-decl3.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("truncated-decl3.xml", 1, 38),
                    .info = XMLERR(ERROR, XML, P_XMLDecl),
                    .msg = "Malformed XMLDecl: expect pseudo-attribute name or ?> here",
            ),
            EV(ENTITY_NOT_LOADED,
                    NOLOC,
                    .type = XML_READER_REF_DOCUMENT,
                    .system_id = TOK("truncated-decl3.xml"),
            ),
            END,
        },
    },
    {
        TC("Truncated declaration #4"),
        .input = "truncated-decl4.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("truncated-decl4.xml", 1, 30),
                    .info = XMLERR(ERROR, XML, P_XMLDecl),
                    .msg = "Quoted literal expected",
            ),
            EV(ENTITY_NOT_LOADED,
                    NOLOC,
                    .type = XML_READER_REF_DOCUMENT,
                    .system_id = TOK("truncated-decl4.xml"),
            ),
            END,
        },
    },
    {
        TC("Truncated declaration #5"),
        .input = "truncated-decl5.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("truncated-decl5.xml", 2, 1),
                    .info = XMLERR(ERROR, XML, P_XMLDecl),
                    .msg = "Expect pseudo-attribute or ?> here",
            ),
            EV(ENTITY_NOT_LOADED,
                    NOLOC,
                    .type = XML_READER_REF_DOCUMENT,
                    .system_id = TOK("truncated-decl5.xml"),
            ),
            END,
        },
    },
    {
        TC("Non-ASCII character in declaration"),
        .input = "nonascii-decl.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("nonascii-decl.xml", 4, 9),
                    .info = XMLERR(ERROR, XML, P_XMLDecl),
                    .msg = "Malformed XMLDecl: non-ASCII character",
            ),
            EV(MESSAGE,
                    LOC("nonascii-decl.xml", 4, 9),
                    .info = XMLERR(ERROR, XML, P_XMLDecl),
                    .msg = "Malformed XMLDecl: unexpected pseudo-attribute",
            ),
            EV(XMLDECL,
                    LOC("nonascii-decl.xml", 4, 27),
                    .encoding = NULL,
                    .standalone = XML_INFO_STANDALONE_YES,
                    .version = XML_INFO_VERSION_1_1,
            ),
            EV(STAG,
                    LOC("nonascii-decl.xml", 5, 1),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("nonascii-decl.xml", 5, 3)
            ),
            END,
        },
    },
    {
        TC("No mandatory attribute #1"),
        .input = "decl-no-version1.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("decl-no-version1.xml", 1, 7),
                    .info = XMLERR(ERROR, XML, P_XMLDecl),
                    .msg = "Mandatory pseudo-attribute 'version' missing in XMLDecl",
            ),
            EV(XMLDECL,
                    LOC("decl-no-version1.xml", 1, 39),
                    .encoding = "UTF-8",
                    .standalone = XML_INFO_STANDALONE_NO,
                    .version = XML_INFO_VERSION_NO_VALUE,
            ),
            EV(STAG,
                    LOC("decl-no-version1.xml", 1, 41),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("decl-no-version1.xml", 1, 43)
            ),
            END,
        },
    },
    {
        TC("No mandatory attribute #2"),
        .input = "decl-no-version2.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("decl-no-version2.xml", 1, 7),
                    .info = XMLERR(ERROR, XML, P_XMLDecl),
                    .msg = "Mandatory pseudo-attribute 'version' missing in XMLDecl",
            ),
            EV(XMLDECL,
                    LOC("decl-no-version2.xml", 1, 7),
                    .encoding = NULL,
                    .standalone = XML_INFO_STANDALONE_NO_VALUE,
                    .version = XML_INFO_VERSION_NO_VALUE,
            ),
            EV(STAG,
                    LOC("decl-no-version2.xml", 1, 9),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("decl-no-version2.xml", 1, 11)
            ),
            END,
        },
    },
    {
        TC("Wrong order of pseudo-attributes"),
        .input = "decl-wrong-order.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("decl-wrong-order.xml", 1, 7),
                    .info = XMLERR(ERROR, XML, P_XMLDecl),
                    .msg = "Mandatory pseudo-attribute 'version' missing in XMLDecl",
            ),
            EV(MESSAGE,
                    LOC("decl-wrong-order.xml", 1, 24),
                    .info = XMLERR(ERROR, XML, P_XMLDecl),
                    .msg = "Malformed XMLDecl: unexpected pseudo-attribute",
            ),
            EV(XMLDECL,
                    LOC("decl-wrong-order.xml", 1, 37),
                    .encoding = "UTF-8",
                    .standalone = XML_INFO_STANDALONE_NO_VALUE,
                    .version = XML_INFO_VERSION_NO_VALUE,
            ),
            EV(STAG,
                    LOC("decl-wrong-order.xml", 1, 39),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("decl-wrong-order.xml", 1, 41)
            ),
            END,
        },
    },
    {
        TC("Extra pseudo-attribute at the end"),
        .input = "decl-extra-attr1.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("decl-extra-attr1.xml", 1, 55),
                    .info = XMLERR(ERROR, XML, P_XMLDecl),
                    .msg = "Malformed XMLDecl: unexpected pseudo-attribute",
            ),
            EV(XMLDECL,
                    LOC("decl-extra-attr1.xml", 1, 68),
                    .encoding = "UTF-8",
                    .standalone = XML_INFO_STANDALONE_YES,
                    .version = XML_INFO_VERSION_1_0,
            ),
            EV(STAG,
                    LOC("decl-extra-attr1.xml", 1, 70),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("decl-extra-attr1.xml", 1, 72)
            ),
            END,
        },
    },
    {
        TC("Malformed declaration #1"),
        .input = "decl-malformed1.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("decl-malformed1.xml", 1, 20),
                    .info = XMLERR(ERROR, XML, P_XMLDecl),
                    .msg = "Malformed XMLDecl: expect whitespace or ?> here",
            ),
            EV(ENTITY_NOT_LOADED,
                    NOLOC,
                    .type = XML_READER_REF_DOCUMENT,
                    .system_id = TOK("decl-malformed1.xml"),
            ),
            END,
        },
    },
    {
        TC("Pseudo-attribute without = #1"),
        .input = "decl-no-equal1.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("decl-no-equal1.xml", 1, 29),
                    .info = XMLERR(ERROR, XML, P_XMLDecl),
                    .msg = "Expected string: '='",
            ),
            EV(ENTITY_NOT_LOADED,
                    NOLOC,
                    .type = XML_READER_REF_DOCUMENT,
                    .system_id = TOK("decl-no-equal1.xml"),
            ),
            END,
        },
    },
    {
        TC("Pseudo-attribute without = #2"),
        .input = "decl-no-equal2.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("decl-no-equal2.xml", 1, 14),
                    .info = XMLERR(ERROR, XML, P_XMLDecl),
                    .msg = "Expected string: '='",
            ),
            EV(ENTITY_NOT_LOADED,
                    NOLOC,
                    .type = XML_READER_REF_DOCUMENT,
                    .system_id = TOK("decl-no-equal2.xml"),
            ),
            END,
        },
    },
    {
        TC("Pseudo-attribute without quotes"),
        .input = "decl-no-quote.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("decl-no-quote.xml", 1, 32),
                    .info = XMLERR(ERROR, XML, P_XMLDecl),
                    .msg = "Quoted literal expected",
            ),
            EV(ENTITY_NOT_LOADED,
                    NOLOC,
                    .type = XML_READER_REF_DOCUMENT,
                    .system_id = TOK("decl-no-quote.xml"),
            ),
            END,
        },
    },
    {
        TC("Future XML 1.x version"),
        .input = "decl-xml-1.2.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("decl-xml-1.2.xml", 1, 7),
                    .info = XMLERR(WARN, XML, FUTURE_VERSION),
                    .msg = "Document specifies unknown 1.x XML version",
            ),
            EV(XMLDECL,
                    LOC("decl-xml-1.2.xml", 1, 20),
                    .encoding = NULL,
                    .standalone = XML_INFO_STANDALONE_NO_VALUE,
                    .version = XML_INFO_VERSION_1_0,
            ),
            EV(STAG,
                    LOC("decl-xml-1.2.xml", 1, 22),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("decl-xml-1.2.xml", 1, 24)
            ),
            END,
        },
    },
    {
        TC("Unsupported XML version #1"),
        .input = "decl-xml-1.A.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("decl-xml-1.A.xml", 1, 7),
                    .info = XMLERR(ERROR, XML, P_XMLDecl),
                    .msg = "Unsupported XML version",
            ),
            EV(XMLDECL,
                    LOC("decl-xml-1.A.xml", 1, 20),
                    .encoding = NULL,
                    .standalone = XML_INFO_STANDALONE_NO_VALUE,
                    .version = XML_INFO_VERSION_NO_VALUE,
            ),
            EV(STAG,
                    LOC("decl-xml-1.A.xml", 1, 22),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("decl-xml-1.A.xml", 1, 24)
            ),
            END,
        },
    },
    {
        TC("Unsupported XML version #2"),
        .input = "decl-xml-2.0.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("decl-xml-2.0.xml", 1, 7),
                    .info = XMLERR(ERROR, XML, P_XMLDecl),
                    .msg = "Unsupported XML version",
            ),
            EV(XMLDECL,
                    LOC("decl-xml-2.0.xml", 1, 20),
                    .encoding = NULL,
                    .standalone = XML_INFO_STANDALONE_NO_VALUE,
                    .version = XML_INFO_VERSION_NO_VALUE,
            ),
            EV(STAG,
                    LOC("decl-xml-2.0.xml", 1, 22),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("decl-xml-2.0.xml", 1, 24)
            ),
            END,
        },
    },
    {
        TC("Invalid standalone specification"),
        .input = "decl-invalid-standalone2.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("decl-invalid-standalone2.xml", 1, 21),
                    .info = XMLERR(ERROR, XML, P_XMLDecl),
                    .msg = "Unsupported standalone status",
            ),
            EV(XMLDECL,
                    LOC("decl-invalid-standalone2.xml", 1, 37),
                    .encoding = NULL,
                    .standalone = XML_INFO_STANDALONE_NO_VALUE,
                    .version = XML_INFO_VERSION_1_1,
            ),
            EV(MESSAGE,
                    LOC("decl-invalid-standalone2.xml", 2, 1),
                    .info = XMLERR(ERROR, XML, P_document),
                    .msg = "No root element",
            ),
            END,
        },
    },
    {
        TC("Invalid version/standalone specification"),
        .input = "decl-xml-1.xx.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("decl-xml-1.xx.xml", 1, 7),
                    .info = XMLERR(ERROR, XML, P_XMLDecl),
                    .msg = "Unsupported XML version",
            ),
            EV(MESSAGE,
                    LOC("decl-xml-1.xx.xml", 1, 20),
                    .info = XMLERR(ERROR, XML, P_XMLDecl),
                    .msg = "Unsupported standalone status",
            ),
            EV(XMLDECL,
                    LOC("decl-xml-1.xx.xml", 1, 35),
                    .encoding = NULL,
                    .standalone = XML_INFO_STANDALONE_NO_VALUE,
                    .version = XML_INFO_VERSION_NO_VALUE,
            ),
            EV(MESSAGE,
                    LOC("decl-xml-1.xx.xml", 2, 1),
                    .info = XMLERR(ERROR, XML, P_document),
                    .msg = "No root element",
            ),
            END,
        },
    },
    {
        TC("Invalid encoding value #1"),
        .input = "decl-invalid-encoding.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("decl-invalid-encoding.xml", 1, 21),
                    .info = XMLERR(ERROR, XML, P_XMLDecl),
                    .msg = "Invalid encoding name",
            ),
            EV(XMLDECL,
                    LOC("decl-invalid-encoding.xml", 1, 35),
                    .encoding = NULL,
                    .standalone = XML_INFO_STANDALONE_NO_VALUE,
                    .version = XML_INFO_VERSION_1_1,
            ),
            EV(STAG,
                    LOC("decl-invalid-encoding.xml", 1, 37),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("decl-invalid-encoding.xml", 1, 39)
            ),
            END,
        },
    },
    {
        TC("Invalid encoding value #2"),
        .input = "decl-invalid-encoding2.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("decl-invalid-encoding2.xml", 1, 21),
                    .info = XMLERR(ERROR, XML, P_XMLDecl),
                    .msg = "Invalid encoding name",
            ),
            EV(XMLDECL,
                    LOC("decl-invalid-encoding2.xml", 1, 39),
                    .encoding = NULL,
                    .standalone = XML_INFO_STANDALONE_NO_VALUE,
                    .version = XML_INFO_VERSION_1_1,
            ),
            EV(STAG,
                    LOC("decl-invalid-encoding2.xml", 1, 41),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("decl-invalid-encoding2.xml", 1, 43)
            ),
            END,
        },
    },
    {
        TC("Invalid standalone value"),
        .input = "decl-invalid-standalone.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("decl-invalid-standalone.xml", 1, 21),
                    .info = XMLERR(ERROR, XML, P_XMLDecl),
                    .msg = "Unsupported standalone status",
            ),
            EV(XMLDECL,
                    LOC("decl-invalid-standalone.xml", 1, 39),
                    .encoding = NULL,
                    .standalone = XML_INFO_STANDALONE_NO_VALUE,
                    .version = XML_INFO_VERSION_1_0,
            ),
            EV(STAG,
                    LOC("decl-invalid-standalone.xml", 1, 41),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("decl-invalid-standalone.xml", 1, 43)
            ),
            END,
        },
    },
    {
        TC("Bad attribute in declaration"),
        .input = "decl-bad-attr.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("decl-bad-attr.xml", 1, 7),
                    .info = XMLERR(ERROR, XML, P_XMLDecl),
                    .msg = "Mandatory pseudo-attribute 'version' missing in XMLDecl",
            ),
            EV(MESSAGE,
                    LOC("decl-bad-attr.xml", 1, 7),
                    .info = XMLERR(ERROR, XML, P_XMLDecl),
                    .msg = "Malformed XMLDecl: unexpected pseudo-attribute",
            ),
            EV(XMLDECL,
                    LOC("decl-bad-attr.xml", 1, 20),
                    .encoding = NULL,
                    .standalone = XML_INFO_STANDALONE_NO_VALUE,
                    .version = XML_INFO_VERSION_NO_VALUE,
            ),
            EV(MESSAGE,
                    LOC("decl-bad-attr.xml", 2, 1),
                    .info = XMLERR(ERROR, XML, P_document),
                    .msg = "No root element",
            ),
            END,
        },
    },
    {
        TC("Processing instruction starting with 'xml'"),
        .input = "xml-pi.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(PI,
                    LOC("xml-pi.xml", 1, 1),
                    .target = TOK("xml-pi"),
            ),
            EV(MESSAGE,
                    LOC("xml-pi.xml", 2, 1),
                    .info = XMLERR(ERROR, XML, P_document),
                    .msg = "No root element",
            ),
            END,
        },
    },
    {
        TC("Missing whitespace between attributes"),
        .input = "decl-missing-ws.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("decl-missing-ws.xml", 1, 20),
                    .info = XMLERR(ERROR, XML, P_XMLDecl),
                    .msg = "Malformed XMLDecl: expect whitespace or ?> here",
            ),
            EV(ENTITY_NOT_LOADED,
                NOLOC,
                    .type = XML_READER_REF_DOCUMENT,
                    .system_id = TOK("decl-missing-ws.xml"),
            ),
            END,
        },
    },
    {
        TC("Document with no declaration in non-UTF8/UTF16 encoding"),
        .input = "simple-no-decl.xml",
        .encoding = "IBM037",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("simple-no-decl.xml", 1, 1),
                    .info = XMLERR(ERROR, XML, ENCODING_ERROR),
                    .msg = "No external encoding information, "
                    "no encoding in XMLDecl, content in IBM500 encoding",
            ),
            EV(STAG,
                    LOC("simple-no-decl.xml", 1, 1),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("simple-no-decl.xml", 1, 3)
            ),
            END,
        },
    },
    {
        .desc = "Document with no declaration in non-UTF8/UTF16 encoding "
                "(has transport encoding)",
        .input = "simple-no-decl.xml",
        .encoding = "IBM037",
        .transport_encoding = "IBM500",
        .events = (const xml_reader_cbparam_t[]){
            EV(STAG,
                    LOC("simple-no-decl.xml", 1, 1),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("simple-no-decl.xml", 1, 3)
            ),
            END,
        },
    },
    {
        TC("Position updates with combining marks"),
        .input = "combining-mark.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(STAG,
                    LOC("combining-mark.xml", 1, 1),
                    .name = TOK("a\xCC\x81"),
            ),
            EV(ETAG,
                    LOC("combining-mark.xml", 1, 4),
                    .name = TOK("a\xCC\x81"),
            ),
            END,
        },
    },
    {
        TC("NUL/restricted characters in input (1.0)"),
        .input = "nul-restricted-char-1.0.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("nul-restricted-char-1.0.xml", 1, 19),
                    .info = XMLERR(ERROR, XML, P_Char),
                    .msg = "NUL character encountered",
            ),
            EV(XMLDECL,
                    LOC("nul-restricted-char-1.0.xml", 1, 20),
                    .encoding = NULL,
                    .standalone = XML_INFO_STANDALONE_NO_VALUE,
                    .version = XML_INFO_VERSION_1_0,
            ),
            EV(STAG,
                    LOC("nul-restricted-char-1.0.xml", 2, 1),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("nul-restricted-char-1.0.xml", 2, 3)
            ),
            EV(MESSAGE,
                    LOC("nul-restricted-char-1.0.xml", 3, 6),
                    .info = XMLERR(ERROR, XML, P_Char),
                    .msg = "Restricted character U+0001",
            ),
            EV(MESSAGE,
                    LOC("nul-restricted-char-1.0.xml", 4, 1),
                    .info = XMLERR(ERROR, XML, P_Char),
                    .msg = "Restricted character U+001E",
            ),
            EV(COMMENT,
                    LOC("nul-restricted-char-1.0.xml", 3, 1),
                    .text = TOK(" \x01\n\x1E\n\x7F\n\xC2\x9F ")
            ),
            END,
        },
    },
    {
        TC("NUL/restricted characters in input (1.1)"),
        .input = "nul-restricted-char-1.1.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("nul-restricted-char-1.1.xml", 1, 19),
                    .info = XMLERR(ERROR, XML, P_Char),
                    .msg = "NUL character encountered",
            ),
            EV(XMLDECL,
                    LOC("nul-restricted-char-1.1.xml", 1, 20),
                    .encoding = NULL,
                    .standalone = XML_INFO_STANDALONE_NO_VALUE,
                    .version = XML_INFO_VERSION_1_1,
            ),
            EV(STAG,
                    LOC("nul-restricted-char-1.1.xml", 2, 1),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("nul-restricted-char-1.1.xml", 2, 3)
            ),
            EV(MESSAGE,
                    LOC("nul-restricted-char-1.1.xml", 3, 6),
                    .info = XMLERR(ERROR, XML, P_Char),
                    .msg = "Restricted character U+0001",
            ),
            EV(MESSAGE,
                    LOC("nul-restricted-char-1.1.xml", 4, 1),
                    .info = XMLERR(ERROR, XML, P_Char),
                    .msg = "Restricted character U+001E",
            ),
            EV(MESSAGE,
                    LOC("nul-restricted-char-1.1.xml", 5, 1),
                    .info = XMLERR(ERROR, XML, P_Char),
                    .msg = "Restricted character U+007F",
            ),
            EV(MESSAGE,
                    LOC("nul-restricted-char-1.1.xml", 6, 1),
                    .info = XMLERR(ERROR, XML, P_Char),
                    .msg = "Restricted character U+009F",
            ),
            EV(COMMENT,
                    LOC("nul-restricted-char-1.1.xml", 3, 1),
                    .text = TOK(" \x01\n\x1E\n\x7F\n\xC2\x9F "),
            ),
            END,
        },
    },
    {
        TC("Invalid newline inside declaration"),
        .input = "decl-invalid-newline1.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("decl-invalid-newline1.xml", 1, 7),
                    .info = XMLERR(ERROR, XML, P_XMLDecl),
                    .msg = "Malformed XMLDecl: expect pseudo-attribute name or ?> here",
            ),
            EV(ENTITY_NOT_LOADED,
                NOLOC,
                    .type = XML_READER_REF_DOCUMENT,
                    .system_id = TOK("decl-invalid-newline1.xml"),
            ),
            END,
        },
    },
    {
        TC("EOL normalization & whitespace check for CR"),
        .input = "whitespace-cr.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(XMLDECL,
                    LOC("whitespace-cr.xml", 1, 20),
                    .encoding = NULL,
                    .standalone = XML_INFO_STANDALONE_NO_VALUE,
                    .version = XML_INFO_VERSION_1_0,
            ),
            EV(DTD_BEGIN,
                    LOC("whitespace-cr.xml", 2, 1),
                    .root = TOK("a"),
            ),
            EV(ENTITY_DEF,
                    LOC("whitespace-cr.xml", 4, 2),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("foo"),
                    .text = TOK("<a\rb='c'/>"),
            ),
            E0(DTD_END_INTERNAL,
                    LOC("whitespace-cr.xml", 4, 32)
            ),
            E0(DTD_END,
                    LOC("whitespace-cr.xml", 4, 34)
            ),
            EV(STAG,
                    LOC("whitespace-cr.xml", 5, 1),
                    .name = TOK("a"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("whitespace-cr.xml", 5, 4),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("foo"),
            ),
            EV(STAG,
                    LOC("entity(foo)", 1, 1),
                    .name = TOK("a"),
            ),
            EV(ATTR,
                    LOC("entity(foo)", 1, 4),
                    .name = TOK("b"),
                    .value = TOK("c"),
            ),
            E0(ETAG,
                    LOC("entity(foo)", 1, 9)
            ),
            EV(ENTITY_PARSE_END,
                    LOC("whitespace-cr.xml", 5, 4),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("foo"),
            ),
            EV(ETAG,
                    LOC("whitespace-cr.xml", 5, 9),
                    .name = TOK("a"),
            ),
            END,
        },
    },
    {
        TC("NameChar and NameStartChar checks"),
        .input = "namechars.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(PI,
                    LOC("namechars.xml", 1, 1),
                    .target = TOK("ABCDEFGHIJKLMNOPQRSTUVWXYZ"),
            ),
            EV(PI,
                    LOC("namechars.xml", 2, 1),
                    .target = TOK("abcdefghijklmnopqrstuvwxyz"),
            ),
            EV(PI,
                    LOC("namechars.xml", 3, 1),
                    .target = TOK("_01234567890-."),
            ),
            EV(PI,
                    LOC("namechars.xml", 4, 1),
                    .target = TOK(":"),
            ),
            EV(PI,
                    LOC("namechars.xml", 5, 1),
                    .target = TOK("\xC3\x80\xC3\x96\xCC\x80"),
            ),
            EV(PI,
                    LOC("namechars.xml", 6, 1),
                    .target = TOK("\xC3\x98\xC3\xB6\xCD\xAF"),
            ),
            EV(PI,
                    LOC("namechars.xml", 7, 1),
                    .target = TOK("\xC3\xB8\xCB\xBF"),
            ),
            EV(PI,
                    LOC("namechars.xml", 8, 1),
                    .target = TOK("\xCD\xB0\xCD\xBD"),
            ),
            EV(PI,
                    LOC("namechars.xml", 9, 1),
                    .target = TOK("\xCD\xBF\xE1\xBF\xBF\xE2\x80\xBF"),
            ),
            EV(PI,
                    LOC("namechars.xml", 10, 1),
                    .target = TOK("\xE2\x80\x8C\xE2\x80\x8D\xE2\x81\x80"),
            ),
            EV(PI,
                    LOC("namechars.xml", 11, 1),
                    .target = TOK("\xE2\x81\xB0\xE2\x86\x8F"),
            ),
            EV(PI,
                    LOC("namechars.xml", 12, 1),
                    .target = TOK("\xE2\xB0\x80\xE2\xBF\xAF"),
            ),
            EV(PI,
                    LOC("namechars.xml", 13, 1),
                    .target = TOK("\xE3\x80\x81\xED\x9F\xBF"),
            ),
            EV(PI,
                    LOC("namechars.xml", 14, 1),
                    .target = TOK("\xEF\xA4\x80\xEF\xB7\x8F\xC2\xB7"),
            ),
            EV(PI,
                    LOC("namechars.xml", 15, 1),
                    .target = TOK("\xEF\xB7\xB0\xEF\xBF\xBD"),
            ),
            EV(PI,
                    LOC("namechars.xml", 16, 1),
                    .target = TOK("\xF0\x90\x80\x80\xF3\xAF\xBF\xBF"),
            ),
            EV(MESSAGE,
                    LOC("namechars.xml", 17, 3),
                    .info = XMLERR(ERROR, XML, P_PI),
                    .msg = "Expected PI target here",
            ),
            EV(MESSAGE,
                    LOC("namechars.xml", 18, 3),
                    .info = XMLERR(ERROR, XML, P_PI),
                    .msg = "Expected PI target here",
            ),
            EV(MESSAGE,
                    LOC("namechars.xml", 19, 3),
                    .info = XMLERR(ERROR, XML, P_PI),
                    .msg = "Expected PI target here",
            ),
            EV(MESSAGE,
                    LOC("namechars.xml", 20, 3),
                    .info = XMLERR(ERROR, XML, P_PI),
                    .msg = "Expected PI target here",
            ),
            EV(MESSAGE,
                    LOC("namechars.xml", 21, 3),
                    .info = XMLERR(ERROR, XML, P_PI),
                    .msg = "Expected PI target here",
            ),
            EV(MESSAGE,
                    LOC("namechars.xml", 22, 3),
                    .info = XMLERR(ERROR, XML, P_PI),
                    .msg = "Expected PI target here",
            ),
            EV(MESSAGE,
                    LOC("namechars.xml", 23, 3),
                    .info = XMLERR(ERROR, XML, P_PI),
                    .msg = "Expected PI target here",
            ),
            EV(MESSAGE,
                    LOC("namechars.xml", 24, 3),
                    .info = XMLERR(ERROR, XML, P_PI),
                    .msg = "Expected PI target here",
            ),
            EV(MESSAGE,
                    LOC("namechars.xml", 25, 3),
                    .info = XMLERR(ERROR, XML, P_PI),
                    .msg = "Expected PI target here",
            ),
            EV(MESSAGE,
                    LOC("namechars.xml", 26, 3),
                    .info = XMLERR(ERROR, XML, P_PI),
                    .msg = "Expected PI target here",
            ),
            EV(MESSAGE,
                    LOC("namechars.xml", 27, 3),
                    .info = XMLERR(ERROR, XML, P_PI),
                    .msg = "Expected PI target here",
            ),
            EV(MESSAGE,
                    LOC("namechars.xml", 28, 3),
                    .info = XMLERR(ERROR, XML, P_PI),
                    .msg = "Expected PI target here",
            ),
            EV(MESSAGE,
                    LOC("namechars.xml", 29, 3),
                    .info = XMLERR(ERROR, XML, P_PI),
                    .msg = "Expected PI target here",
            ),
            EV(MESSAGE,
                    LOC("namechars.xml", 30, 3),
                    .info = XMLERR(ERROR, XML, P_PI),
                    .msg = "Expected PI target here",
            ),
            EV(MESSAGE,
                    LOC("namechars.xml", 31, 3),
                    .info = XMLERR(ERROR, XML, P_PI),
                    .msg = "Expected PI target here",
            ),
            EV(MESSAGE,
                    LOC("namechars.xml", 32, 3),
                    .info = XMLERR(ERROR, XML, P_PI),
                    .msg = "Expected PI target here",
            ),
            EV(MESSAGE,
                    LOC("namechars.xml", 33, 3),
                    .info = XMLERR(ERROR, XML, P_PI),
                    .msg = "Expected PI target here",
            ),
            EV(MESSAGE,
                    LOC("namechars.xml", 34, 3),
                    .info = XMLERR(ERROR, XML, P_PI),
                    .msg = "Expected PI target here",
            ),
            EV(MESSAGE,
                    LOC("namechars.xml", 35, 3),
                    .info = XMLERR(ERROR, XML, P_PI),
                    .msg = "Expected PI target here",
            ),
            EV(MESSAGE,
                    LOC("namechars.xml", 36, 3),
                    .info = XMLERR(ERROR, XML, P_PI),
                    .msg = "Expected PI target here",
            ),
            EV(MESSAGE,
                    LOC("namechars.xml", 37, 3),
                    .info = XMLERR(ERROR, XML, P_PI),
                    .msg = "Expected PI target here",
            ),
            EV(MESSAGE,
                    LOC("namechars.xml", 38, 1),
                    .info = XMLERR(ERROR, XML, P_document),
                    .msg = "No root element",
            ),
            END,
        },
    },
};

// To avoid defining this monster inline...
#define VERY_LONG_NAME \
        "abcdefghabcdefghabcdefghabcdefghabcdefghabcdefghabcdefghabcdefgh" \
        "abcdefghabcdefghabcdefghabcdefghabcdefghabcdefghabcdefghabcdefgh" \
        "abcdefghabcdefghabcdefghabcdefghabcdefghabcdefghabcdefghabcdefgh" \
        "abcdefghabcdefghabcdefghabcdefghabcdefghabcdefghabcdefghabcdefgh" \
        "abcdefghabcdefghabcdefghabcdefghabcdefghabcdefghabcdefghabcdefgh" \
        "abcdefghabcdefghabcdefghabcdefghabcdefghabcdefghabcdefghabcdefgh" \
        "abcdefghabcdefghabcdefghabcdefghabcdefghabcdefghabcdefghabcdefgh" \
        "abcdefghabcdefghabcdefghabcdefghabcdefghabcdefghabcdefghabcdefgh" \
        "abcdefghabcdefghabcdefghabcdefghabcdefghabcdefghabcdefghabcdefgh" \
        "abcdefghabcdefghabcdefghabcdefghabcdefghabcdefghabcdefghabcdefgh" \
        "abcdefghabcdefghabcdefghabcdefghabcdefghabcdefghabcdefghabcdefgh" \
        "abcdefghabcdefghabcdefghabcdefghabcdefghabcdefghabcdefghabcdefgh" \
        "abcdefghabcdefghabcdefghabcdefghabcdefghabcdefghabcdefghabcdefgh" \
        "abcdefghabcdefghabcdefghabcdefghabcdefghabcdefghabcdefghabcdefgh" \
        "abcdefghabcdefghabcdefghabcdefghabcdefghabcdefghabcdefghabcdefgh" \
        "abcdefghabcdefghabcdefghabcdefghabcdefghabcdefghabcdefghabcdefgh" \
        "abcdefgh"


static const testcase_t testcases_structure[] = {
    {
        TC("Simple opening/closing tags"),
        .input = "simple-open-close.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(XMLDECL,
                    LOC("simple-open-close.xml", 1, 37),
                    .encoding = "UTF-8",
                    .standalone = XML_INFO_STANDALONE_NO_VALUE,
                    .version = XML_INFO_VERSION_1_0,
            ),
            EV(STAG,
                    LOC("simple-open-close.xml", 2, 1),
                    .name = TOK("a"),
            ),
            EV(ETAG,
                    LOC("simple-open-close.xml", 2, 4),
                    .name = TOK("a"),
            ),
            END,
        },
    },
    {
        TC("Invalid top-level content (no XMLDecl)"),
        .input = "invalid-top-level-nodecl.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("invalid-top-level-nodecl.xml", 1, 1),
                    .info = XMLERR(ERROR, XML, P_document),
                    .msg = "Invalid content at root level",
            ),
            EV(MESSAGE,
                    LOC("invalid-top-level-nodecl.xml", 2, 1),
                    .info = XMLERR(ERROR, XML, P_document),
                    .msg = "No root element",
            ),
            END,
        },
    },
    {
        TC("Invalid top-level content (with XMLDecl)"),
        .input = "invalid-top-level.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(XMLDECL,
                    LOC("invalid-top-level.xml", 1, 37),
                    .encoding = "UTF-8",
                    .standalone = XML_INFO_STANDALONE_NO_VALUE,
                    .version = XML_INFO_VERSION_1_1,
            ),
            EV(MESSAGE,
                    LOC("invalid-top-level.xml", 2, 1),
                    .info = XMLERR(ERROR, XML, P_document),
                    .msg = "Invalid content at root level",
            ),
            EV(MESSAGE,
                    LOC("invalid-top-level.xml", 3, 1),
                    .info = XMLERR(ERROR, XML, P_document),
                    .msg = "No root element",
            ),
            END,
        },
    },
    {
        TC("Invalid top-level content (with XMLDecl & root element)"),
        .input = "invalid-top-level-withroot.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(XMLDECL,
                    LOC("invalid-top-level-withroot.xml", 1, 37),
                    .encoding = "UTF-8",
                    .standalone = XML_INFO_STANDALONE_NO_VALUE,
                    .version = XML_INFO_VERSION_1_1,
            ),
            EV(MESSAGE,
                    LOC("invalid-top-level-withroot.xml", 2, 1),
                    .info = XMLERR(ERROR, XML, P_document),
                    .msg = "Invalid content at root level",
            ),
            EV(STAG,
                    LOC("invalid-top-level-withroot.xml", 3, 1),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("invalid-top-level-withroot.xml", 3, 3)
            ),
            END,
        },
    },
    {
        TC("DTD specified twice"),
        .input = "dtd-twice.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(DTD_BEGIN,
                    LOC("dtd-twice.xml", 1, 1),
                    .root = TOK("a"),
            ),
            E0(DTD_END,
                    LOC("dtd-twice.xml", 1, 13)
            ),
            EV(MESSAGE,
                    LOC("dtd-twice.xml", 2, 1),
                    .info = XMLERR(ERROR, XML, P_document),
                    .msg = "Document type definition not allowed here",
            ),
            EV(DTD_BEGIN,
                    LOC("dtd-twice.xml", 2, 1),
                    .root = TOK("a"),
            ),
            E0(DTD_END,
                    LOC("dtd-twice.xml", 2, 13)
            ),
            EV(STAG,
                    LOC("dtd-twice.xml", 3, 1),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("dtd-twice.xml", 3, 3)
            ),
            END,
        },
    },
    {
        TC("DTD specified after root element"),
        .input = "dtd-after-element.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(STAG,
                    LOC("dtd-after-element.xml", 1, 1),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("dtd-after-element.xml", 1, 3)
            ),
            EV(MESSAGE,
                    LOC("dtd-after-element.xml", 2, 1),
                    .info = XMLERR(ERROR, XML, P_document),
                    .msg = "Document type definition not allowed here",
            ),
            EV(DTD_BEGIN,
                    LOC("dtd-after-element.xml", 2, 1),
                    .root = TOK("a"),
            ),
            E0(DTD_END,
                    LOC("dtd-after-element.xml", 2, 13)
            ),
            END,
        },
    },
    {
        TC("Root element specified twice"),
        .input = "root-element-twice.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(STAG,
                    LOC("root-element-twice.xml", 1, 1),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("root-element-twice.xml", 1, 3)
            ),
            EV(MESSAGE,
                    LOC("root-element-twice.xml", 2, 1),
                    .info = XMLERR(ERROR, XML, P_document),
                    .msg = "One root element allowed in a document",
            ),
            EV(STAG,
                    LOC("root-element-twice.xml", 2, 1),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("root-element-twice.xml", 2, 3)
            ),
            END,
        },
    },
    {
        TC("No root element"),
        .input = "no-root-element.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(XMLDECL,
                    LOC("no-root-element.xml", 1, 20),
                    .encoding = NULL,
                    .standalone = XML_INFO_STANDALONE_NO_VALUE,
                    .version = XML_INFO_VERSION_1_1,
            ),
            EV(COMMENT,
                    LOC("no-root-element.xml", 3, 1),
                    .text = TOK(" Comment "),
            ),
            EV(MESSAGE,
                    LOC("no-root-element.xml", 4, 1),
                    .info = XMLERR(ERROR, XML, P_document),
                    .msg = "No root element",
            ),
            END,
        },
    },
    {
        TC("Bad element type in empty tag"),
        .input = "bad-emptytag-name.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("bad-emptytag-name.xml", 1, 2),
                    .info = XMLERR(ERROR, XML, P_STag),
                    .msg = "Expected element type",
            ),
            END,
        },
    },
    {
        TC("Bad element type in start tag"),
        .input = "bad-stag-name.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("bad-stag-name.xml", 1, 2),
                    .info = XMLERR(ERROR, XML, P_STag),
                    .msg = "Expected element type",
            ),
            END,
        },
    },
    {
        TC("Truncated start tag"),
        .input = "truncated-stag.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(STAG,
                    LOC("truncated-stag.xml", 1, 1),
                    .name = TOK("a"),
            ),
            EV(MESSAGE,
                    LOC("truncated-stag.xml", 2, 1),
                    .info = XMLERR(ERROR, XML, P_STag),
                    .msg = "Expect attribute name, or >, or /> here",
            ),
            END,
        },
    },
    {
        TC("Bad character in start tag #1"),
        .input = "stag-badchar1.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(STAG,
                    LOC("stag-badchar1.xml", 1, 1),
                    .name = TOK("element"),
            ),
            EV(MESSAGE,
                    LOC("stag-badchar1.xml", 1, 9),
                    .info = XMLERR(ERROR, XML, P_STag),
                    .msg = "Expect whitespace, or >, or /> here",
            ),
            END,
        },
    },
    {
        TC("Bad character in start tag #2"),
        .input = "stag-badchar2.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(STAG,
                    LOC("stag-badchar2.xml", 1, 1),
                    .name = TOK("element"),
            ),
            EV(MESSAGE,
                    LOC("stag-badchar2.xml", 1, 10),
                    .info = XMLERR(ERROR, XML, P_STag),
                    .msg = "Expect attribute name here",
            ),
            END,
        },
    },
    {
        TC("Malformed start tags"),
        .input = "stag-malformed.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(STAG,
                    LOC("stag-malformed.xml", 1, 1),
                    .name = TOK("a"),
            ),
            EV(TEXT,
                    LOC("stag-malformed.xml", 1, 4),
                    .text = TOK("\n "),
                    .ws = true,
            ),
            EV(STAG,
                    LOC("stag-malformed.xml", 2, 2),
                    .name = TOK("x"),
            ),
            EV(MESSAGE,
                    LOC("stag-malformed.xml", 2, 4),
                    .info = XMLERR(ERROR, XML, P_STag),
                    .msg = "Expect whitespace, or >, or /> here",
            ),
            EV(TEXT,
                    LOC("stag-malformed.xml", 2, 7),
                    .text = TOK("\n "),
                    .ws = true,
            ),
            EV(STAG,
                    LOC("stag-malformed.xml", 3, 2),
                    .name = TOK("y"),
            ),
            EV(MESSAGE,
                    LOC("stag-malformed.xml", 3, 6),
                    .info = XMLERR(ERROR, XML, P_Attribute),
                    .msg = "Expected string: '='",
            ),
            EV(TEXT,
                    LOC("stag-malformed.xml", 3, 8),
                    .text = TOK("\n"),
                    .ws = true,
            ),
            EV(ETAG,
                    LOC("stag-malformed.xml", 4, 1),
                    .name = TOK("a"),
            ),
            // <x... is interpreted as a STag, so the parser assumes we're still in non-root element
            EV(TEXT,
                    LOC("stag-malformed.xml", 4, 5),
                    .text = TOK("\n"),
                    .ws = true,
            ),
            EV(MESSAGE,
                    LOC("stag-malformed.xml", 5, 1),
                    .info = XMLERR(ERROR, XML, P_content),
                    .msg = "Replacement text for an entity must match 'content' production",
            ),
            END,
        },
    },
    {
        TC("No name in end tag"),
        .input = "etag-noname.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(STAG,
                    LOC("etag-noname.xml", 1, 1),
                    .name = TOK("a"),
            ),
            EV(MESSAGE,
                    LOC("etag-noname.xml", 1, 6),
                    .info = XMLERR(ERROR, XML, P_ETag),
                    .msg = "Expected element type",
            ),
            EV(TEXT,
                    LOC("etag-noname.xml", 1, 7),
                    .text = TOK("\n"),
                    .ws = true,
            ),
            EV(MESSAGE,
                    LOC("etag-noname.xml", 2, 1),
                    .info = XMLERR(ERROR, XML, P_content),
                    .msg = "Replacement text for an entity must match 'content' production",
            ),
            END,
        },
    },
    {
        TC("Bad name in end tag"),
        .input = "etag-badname.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(STAG,
                    LOC("etag-badname.xml", 1, 1),
                    .name = TOK("a"),
            ),
            EV(MESSAGE,
                    LOC("etag-badname.xml", 1, 6),
                    .info = XMLERR(ERROR, XML, P_ETag),
                    .msg = "Expected element type",
            ),
            EV(TEXT,
                    LOC("etag-badname.xml", 1, 8),
                    .text = TOK("\n"),
                    .ws = true,
            ),
            EV(MESSAGE,
                    LOC("etag-badname.xml", 2, 1),
                    .info = XMLERR(ERROR, XML, P_content),
                    .msg = "Replacement text for an entity must match 'content' production",
            ),
            END,
        },
    },
    {
        TC("End tag mismatch to start tag"),
        .input = "etag-mismatch.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(STAG,
                    LOC("etag-mismatch.xml", 1, 1),
                    .name = TOK("a"),
            ),
            EV(ETAG,
                    LOC("etag-mismatch.xml", 1, 4),
                    .name = TOK("b"),
            ),
            END,
        },
    },
    {
        TC("Missing closing bracket in end tag"),
        .input = "etag-missing-bracket.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(STAG,
                    LOC("etag-missing-bracket.xml", 1, 1),
                    .name = TOK("a"),
            ),
            EV(MESSAGE,
                    LOC("etag-missing-bracket.xml", 2, 1),
                    .info = XMLERR(ERROR, XML, P_ETag),
                    .msg = "Expected string: '>'",
            ),
            // TBD here there should be a message that 'content' production is not matched
            // but it is not produced at this time - move lock-breaking to xml_read_recover
            END,
        },
    },
    {
        TC("Extra (unmatched) end tag"),
        .input = "etag-unpaired.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(STAG,
                    LOC("etag-unpaired.xml", 1, 1),
                    .name = TOK("a"),
            ),
            EV(ETAG,
                    LOC("etag-unpaired.xml", 1, 4),
                    .name = TOK("a"),
            ),
            EV(ETAG,
                    LOC("etag-unpaired.xml", 1, 8),
                    .name = TOK("a"),
            ),
            EV(MESSAGE,
                    LOC("etag-unpaired.xml", 1, 8),
                    .info = XMLERR(ERROR, XML, P_document),
                    .msg = "Document entity must match 'document' production",
            ),
            END,
        },
    },
    {
        TC("Element immediately following XMLDecl in non-ASCII"),
        .input = "element-nonutf8-name.xml",
        .encoding = "ISO-8859-1",
        .events = (const xml_reader_cbparam_t[]){
            EV(XMLDECL,
                    LOC("element-nonutf8-name.xml", 1, 42),
                    .encoding = "ISO-8859-1",
                    .standalone = XML_INFO_STANDALONE_NO_VALUE,
                    .version = XML_INFO_VERSION_1_0,
            ),
            EV(STAG,
                    LOC("element-nonutf8-name.xml", 1, 44),
                    .name = TOK("é"),
            ),
            EV(ETAG,
                    LOC("element-nonutf8-name.xml", 1, 47),
                    .name = TOK("é"),
            ),
            END,
        },
    },
    {
        TC("Comments & Processing instructions"),
        .input = "comments-pis.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(COMMENT,
                    LOC("comments-pis.xml", 1, 1),
                    .text = TOK(" This is a comment "),
            ),
            EV(PI,
                    LOC("comments-pis.xml", 2, 1),
                    .target = TOK("PI"),
                    .content = TOK("some processing insn"),
            ),
            EV(STAG,
                    LOC("comments-pis.xml", 3, 1),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("comments-pis.xml", 3, 3)
            ),
            END,
        },
    },
    {
        TC("Comments & Processing instructions (torture)"),
        .input = "comments-pis-torture.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("comments-pis-torture.xml", 1, 23),
                    .info = XMLERR(ERROR, XML, P_Comment),
                    .msg = "Double hyphen must not occur within comments",
            ),
            EV(COMMENT,
                    LOC("comments-pis-torture.xml", 1, 1),
                    .text = TOK(" Torture - test -- for --- comments ---- backtracking "),
            ),
            EV(PI,
                    LOC("comments-pis-torture.xml", 2, 1),
                    .target = TOK("and"),
                    .content = TOK("? for-pis?? of=\"course\""),
            ),
            EV(MESSAGE,
                    LOC("comments-pis-torture.xml", 3, 4),
                    .info = XMLERR(ERROR, XML, P_PI),
                    .msg = "Expected string: '?>'",
            ),
            EV(PI,
                    LOC("comments-pis-torture.xml", 4, 1),
                    .target = TOK("a"),
                    .content = TOK("???????????????????????????????????"),
            ),
            EV(STAG,
                    LOC("comments-pis-torture.xml", 5, 1),
                    .name = TOK("a"),
            ),
            EV(TEXT,
                    LOC("comments-pis-torture.xml", 5, 4),
                    .text = TOK("\n\t"),
                    .ws = true,
            ),
            EV(COMMENT,
                    LOC("comments-pis-torture.xml", 6, 9),
                    .text = TOK("<!"),
            ),
            EV(TEXT,
                    LOC("comments-pis-torture.xml", 6, 18),
                    .text = TOK("-->\n\t"),
                    .ws = false,
            ),
            EV(PI,
                    LOC("comments-pis-torture.xml", 7, 9),
                    .target = TOK("pi"),
            ),
            EV(TEXT,
                    LOC("comments-pis-torture.xml", 7, 15),
                    .text = TOK("\n\t"),
                    .ws = true,
            ),
            EV(COMMENT,
                    LOC("comments-pis-torture.xml", 8, 9),
                    .text = TOK("*-*-*-*"),
            ),
            EV(TEXT,
                    LOC("comments-pis-torture.xml", 8, 23),
                    .text = TOK("\n\t"),
                    .ws = true,
            ),
            EV(COMMENT,
                    LOC("comments-pis-torture.xml", 9, 9),
                    .text = TOK(""),
            ),
            EV(TEXT,
                    LOC("comments-pis-torture.xml", 9, 16),
                    .text = TOK("\n\t"),
                    .ws = true,
            ),
            EV(COMMENT,
                    LOC("comments-pis-torture.xml", 10, 9),
                    .text = TOK(" "),
            ),
            EV(TEXT,
                    LOC("comments-pis-torture.xml", 10, 17),
                    .text = TOK("\n"),
                    .ws = true,
            ),
            EV(ETAG,
                    LOC("comments-pis-torture.xml", 11, 1),
                    .name = TOK("a"),
            ),
            END,
        },
    },
    {
        TC("Unterminated comment"),
        .input = "unterminated-comment.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(STAG,
                    LOC("unterminated-comment.xml", 1, 1),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("unterminated-comment.xml", 1, 3)
            ),
            EV(MESSAGE,
                    LOC("unterminated-comment.xml", 2, 1),
                    .info = XMLERR(ERROR, XML, P_Comment),
                    .msg = "Unterminated comment",
            ),
            END,
        },
    },
    {
        TC("Unterminated PI #1"),
        .input = "unterminated-pi1.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(STAG,
                    LOC("unterminated-pi1.xml", 1, 1),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("unterminated-pi1.xml", 1, 3)
            ),
            EV(MESSAGE,
                    LOC("unterminated-pi1.xml", 2, 1),
                    .info = XMLERR(ERROR, XML, P_PI),
                    .msg = "Unterminated processing instruction",
            ),
            END,
        },
    },
    {
        TC("Unterminated PI #2"),
        .input = "unterminated-pi2.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(STAG,
                    LOC("unterminated-pi2.xml", 1, 1),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("unterminated-pi2.xml", 1, 3)
            ),
            EV(MESSAGE,
                    LOC("unterminated-pi2.xml", 1, 19),
                    .info = XMLERR(ERROR, XML, P_PI),
                    .msg = "Expected string: '?>'",
            ),
            END,
        },
    },
    {
        TC("Bad PI target"),
        .input = "pi-badtarget.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(STAG,
                    LOC("pi-badtarget.xml", 1, 1),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("pi-badtarget.xml", 1, 3)
            ),
            EV(MESSAGE,
                    LOC("pi-badtarget.xml", 1, 7),
                    .info = XMLERR(ERROR, XML, P_PI),
                    .msg = "Expected PI target here",
            ),
            END,
        },
    },
    {
        TC("Very long element name"),
        .input = "very-long-token.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(STAG,
                    LOC("very-long-token.xml", 1, 1),
                    .name = TOK(VERY_LONG_NAME),
            ),
            E0(ETAG,
                    LOC("very-long-token.xml", 1, 1034)
            ),
            END,
        },
    },
    {
        TC("Attributes"),
        .input = "attributes.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(STAG,
                    LOC("attributes.xml", 1, 1),
                    .name = TOK("a"),
            ),
            EV(ATTR,
                    LOC("attributes.xml", 1, 4),
                    .name = TOK("attr1"),
                    .value = TOK("foo"),
            ),
            EV(ATTR,
                    LOC("attributes.xml", 1, 16),
                    .name = TOK("attr2"),
                    .value = TOK("bar"),
            ),
            E0(ETAG,
                    LOC("attributes.xml", 1, 28)
            ),
            END,
        },
    },
    {
        TC("Attributes with char/entity references"),
        .input = "attribute-with-references.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(STAG,
                    LOC("attribute-with-references.xml", 1, 1),
                    .name = TOK("a"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("attribute-with-references.xml", 1, 8),
                    .name = TOK("lt"),
                    .type = XML_READER_REF_INTERNAL,
            ),
            EV(ENTITY_PARSE_END,
                    LOC("attribute-with-references.xml", 1, 8),
                    .name = TOK("lt"),
                    .type = XML_READER_REF_INTERNAL,
            ),
            EV(ENTITY_PARSE_START,
                    LOC("attribute-with-references.xml", 1, 13),
                    .name = TOK("quot"),
                    .type = XML_READER_REF_INTERNAL,
            ),
            EV(ENTITY_PARSE_END,
                    LOC("attribute-with-references.xml", 1, 13),
                    .name = TOK("quot"),
                    .type = XML_READER_REF_INTERNAL,
            ),
            EV(ENTITY_PARSE_START,
                    LOC("attribute-with-references.xml", 1, 20),
                    .name = TOK("amp"),
                    .type = XML_READER_REF_INTERNAL,
            ),
            EV(ENTITY_PARSE_END,
                    LOC("attribute-with-references.xml", 1, 20),
                    .name = TOK("amp"),
                    .type = XML_READER_REF_INTERNAL,
            ),
            EV(ENTITY_PARSE_START,
                    LOC("attribute-with-references.xml", 1, 26),
                    .name = TOK("gt"),
                    .type = XML_READER_REF_INTERNAL,
            ),
            EV(ENTITY_PARSE_END,
                    LOC("attribute-with-references.xml", 1, 26),
                    .name = TOK("gt"),
                    .type = XML_READER_REF_INTERNAL,
            ),
            EV(ENTITY_PARSE_START,
                    LOC("attribute-with-references.xml", 1, 31),
                    .name = TOK("apos"),
                    .type = XML_READER_REF_INTERNAL,
            ),
            EV(ENTITY_PARSE_END,
                    LOC("attribute-with-references.xml", 1, 31),
                    .name = TOK("apos"),
                    .type = XML_READER_REF_INTERNAL,
            ),
            EV(ENTITY_UNKNOWN,
                    LOC("attribute-with-references.xml", 1, 44),
                    .name = TOK("d"),
                    .type = XML_READER_REF_GENERAL,
            ),
            EV(ATTR,
                    LOC("attribute-with-references.xml", 1, 4),
                    .name = TOK("b"),
                    .value = TOK("z<y\"x&w>v'u\"ce\xD0\xAEg\xD1\x8Ah"),
            ),
            E0(ETAG,
                    LOC("attribute-with-references.xml", 1, 65)
            ),
            END,
        },
    },
    {
        TC("Attributes with invalid references"),
        .input = "attribute-invalid-references1.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(XMLDECL,
                    LOC("attribute-invalid-references1.xml", 1, 20),
                    .encoding = NULL,
                    .standalone = XML_INFO_STANDALONE_NO_VALUE,
                    .version = XML_INFO_VERSION_1_0,
            ),
            EV(STAG,
                    LOC("attribute-invalid-references1.xml", 2, 1),
                    .name = TOK("a"),
            ),
            EV(MESSAGE,
                    LOC("attribute-invalid-references1.xml", 2, 7),
                    .info = XMLERR(ERROR, XML, P_CharRef),
                    .msg = "Character reference did not evaluate to "
                    "a valid UCS-4 code point",
            ),
            EV(MESSAGE,
                    LOC("attribute-invalid-references1.xml", 2, 17),
                    .info = XMLERR(ERROR, XML, P_CharRef),
                    .msg = "Character reference did not evaluate to "
                    "a valid UCS-4 code point",
            ),
            EV(MESSAGE,
                    LOC("attribute-invalid-references1.xml", 2, 30),
                    .info = XMLERR(ERROR, XML, P_CharRef),
                    .msg = "Referenced character does not match Char production",
            ),
            EV(MESSAGE,
                    LOC("attribute-invalid-references1.xml", 2, 35),
                    .info = XMLERR(ERROR, XML, P_CharRef),
                    .msg = "Referenced character does not match Char production",
            ),
            EV(MESSAGE,
                    LOC("attribute-invalid-references1.xml", 2, 43),
                    .info = XMLERR(ERROR, XML, P_CharRef),
                    .msg = "Referenced character does not match Char production",
            ),
            EV(MESSAGE,
                    LOC("attribute-invalid-references1.xml", 2, 51),
                    .info = XMLERR(ERROR, XML, P_CharRef),
                    .msg = "Referenced character does not match Char production",
            ),
            EV(MESSAGE,
                    LOC("attribute-invalid-references1.xml", 2, 59),
                    .info = XMLERR(ERROR, XML, P_Reference),
                    .msg = "Malformed unknown reference",
            ),
            EV(MESSAGE,
                    LOC("attribute-invalid-references1.xml", 2, 61),
                    .info = XMLERR(ERROR, XML, P_CharRef),
                    .msg = "Malformed character reference",
            ),
            EV(MESSAGE,
                    LOC("attribute-invalid-references1.xml", 2, 64),
                    .info = XMLERR(ERROR, XML, P_CharRef),
                    .msg = "Malformed character reference",
            ),
            EV(MESSAGE,
                    LOC("attribute-invalid-references1.xml", 2, 68),
                    .info = XMLERR(ERROR, XML, P_CharRef),
                    .msg = "Malformed character reference",
            ),
            EV(MESSAGE,
                    LOC("attribute-invalid-references1.xml", 2, 72),
                    .info = XMLERR(ERROR, XML, P_EntityRef),
                    .msg = "Malformed general entity reference",
            ),
            EV(MESSAGE,
                    LOC("attribute-invalid-references1.xml", 2, 75),
                    .info = XMLERR(ERROR, XML, P_CharRef),
                    .msg = "Referenced character does not match Char production",
            ),
            EV(ATTR,
                    LOC("attribute-invalid-references1.xml", 2, 4),
                    .name = TOK("b"),
                    .value = TOK(";;;!^"),
            ),
            E0(ETAG,
                    LOC("attribute-invalid-references1.xml", 2, 83)
            ),
            END,
        },
    },
    {
        TC("Attributes with references to restricted characters"),
        .input = "attribute-restricted-references.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(XMLDECL,
                    LOC("attribute-restricted-references.xml", 1, 20),
                    .encoding = NULL,
                    .standalone = XML_INFO_STANDALONE_NO_VALUE,
                    .version = XML_INFO_VERSION_1_1,
            ),
            EV(STAG,
                    LOC("attribute-restricted-references.xml", 2, 1),
                    .name = TOK("a"),
            ),
            EV(ATTR,
                    LOC("attribute-restricted-references.xml", 2, 4),
                    .name = TOK("b"),
                    .value = TOK("\x01\x1F\x7F\xC2\x80"),
            ),
            E0(ETAG,
                    LOC("attribute-restricted-references.xml", 2, 30)
            ),
            END,
        },
    },
    {
        TC("Character data with entity references"),
        .input = "chardata-entities.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(STAG,
                    LOC("chardata-entities.xml", 1, 1),
                    .name = TOK("a"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("chardata-entities.xml", 1, 28),
                    .name = TOK("lt"),
                    .type = XML_READER_REF_INTERNAL,
            ),
            EV(ENTITY_PARSE_END,
                    LOC("chardata-entities.xml", 1, 28),
                    .name = TOK("lt"),
                    .type = XML_READER_REF_INTERNAL,
            ),
            EV(ENTITY_PARSE_START,
                    LOC("chardata-entities.xml", 1, 42),
                    .name = TOK("gt"),
                    .type = XML_READER_REF_INTERNAL,
            ),
            EV(ENTITY_PARSE_END,
                    LOC("chardata-entities.xml", 1, 42),
                    .name = TOK("gt"),
                    .type = XML_READER_REF_INTERNAL,
            ),
            EV(ENTITY_UNKNOWN,
                    LOC("chardata-entities.xml", 1, 58),
                    .name = TOK("custom"),
                    .type = XML_READER_REF_GENERAL,
            ),
            EV(TEXT,
                    LOC("chardata-entities.xml", 1, 4),
                    .text = TOK("This is some text, with < entities > and a  entity."),
                    .ws = false,
            ),
            EV(ETAG,
                    LOC("chardata-entities.xml", 1, 74),
                    .name = TOK("a"),
            ),
            END,
        },
    },
    {
        TC("CDATA section"),
        .input = "cdata.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(STAG,
                    LOC("cdata.xml", 1, 1),
                    .name = TOK("a"),
            ),
            EV(TEXT,
                    LOC("cdata.xml", 1, 4),
                    .text = TOK("A "),
                    .ws = false,
            ),
            EV(CDSECT,
                    LOC("cdata.xml", 1, 6),
                    .text = TOK("section < with & special ]] characters inside"),
                    .ws = false,
            ),
            EV(CDSECT,
                    LOC("cdata.xml", 1, 63),
                    .text = TOK(""),
                    .ws = false,
            ),
            EV(CDSECT,
                    LOC("cdata.xml", 1, 75),
                    .text = TOK(" "),
                    .ws = false,
            ),
            EV(TEXT,
                    LOC("cdata.xml", 1, 88),
                    .text = TOK("."),
                    .ws = false,
            ),
            EV(ETAG,
                    LOC("cdata.xml", 1, 89),
                    .name = TOK("a"),
            ),
            END,
        },
    },
    {
        TC("Unterminated CDATA section"),
        .input = "unterminated-cdata.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(STAG,
                    LOC("unterminated-cdata.xml", 1, 1),
                    .name = TOK("a"),
            ),
            EV(TEXT,
                    LOC("unterminated-cdata.xml", 1, 4),
                    .text = TOK("Unterminated "),
                    .ws = false,
            ),
            EV(MESSAGE,
                    LOC("unterminated-cdata.xml", 2, 1),
                    .info = XMLERR(ERROR, XML, P_CDSect),
                    .msg = "Unterminated CDATA section",
            ),
            // TBD here too, it should also raise an error about not matching 'content'
            END,
        },
    },
    {
        TC("DTD (no subsets)"),
        .input = "dtd-no-subset.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(DTD_BEGIN,
                    LOC("dtd-no-subset.xml", 1, 1),
                    .root = TOK("a"),
            ),
            E0(DTD_END,
                    LOC("dtd-no-subset.xml", 1, 13)
            ),
            EV(STAG,
                    LOC("dtd-no-subset.xml", 2, 1),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("dtd-no-subset.xml", 2, 3)
            ),
            END,
        },
    },
    {
        TC("DTD (external subset with SYSTEM id)"),
        .input = "dtd-ext-system.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(DTD_BEGIN,
                    LOC("dtd-ext-system.xml", 1, 1),
                    .root = TOK("a"),
                    .system_id = TOK("system.dtd"),
            ),
            EV(MESSAGE,
                    LOC("dtd-ext-system.xml", 1, 33),
                    .info = XMLERR(ERROR, XML, ENTITY_LOAD_FAILURE),
                    .msg = "Entity failed to load: system.dtd",
            ),
            EV(ENTITY_NOT_LOADED,
                    LOC("dtd-ext-system.xml", 1, 33),
                    .type = XML_READER_REF_EXT_SUBSET,
                    .system_id = TOK("system.dtd"),
            ),
            E0(DTD_END,
                    LOC("dtd-ext-system.xml", 1, 33)
            ),
            EV(STAG,
                    LOC("dtd-ext-system.xml", 2, 1),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("dtd-ext-system.xml", 2, 3)
            ),
            END,
        },
    },
    {
        TC("DTD (external subset with PUBLIC id)"),
        .input = "dtd-ext-public.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(DTD_BEGIN,
                    LOC("dtd-ext-public.xml", 1, 1),
                    .root = TOK("a"),
                    .public_id = TOK("-//Owner//Document//EN"),
                    .system_id = TOK("system.dtd"),
            ),
            EV(MESSAGE,
                    LOC("dtd-ext-public.xml", 1, 58),
                    .info = XMLERR(ERROR, XML, ENTITY_LOAD_FAILURE),
                    .msg = "Entity failed to load: system.dtd",
            ),
            EV(ENTITY_NOT_LOADED,
                    LOC("dtd-ext-public.xml", 1, 58),
                    .type = XML_READER_REF_EXT_SUBSET,
                    .system_id = TOK("system.dtd"),
                    .public_id = TOK("-//Owner//Document//EN"),
            ),
            E0(DTD_END,
                    LOC("dtd-ext-public.xml", 1, 58)
            ),
            EV(STAG,
                    LOC("dtd-ext-public.xml", 2, 1),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("dtd-ext-public.xml", 2, 3)
            ),
            END,
        },
    },
    {
        TC("DTD (empty internal subset)"),
        .input = "dtd-int-empty.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(DTD_BEGIN,
                    LOC("dtd-int-empty.xml", 1, 1),
                    .root = TOK("a"),
            ),
            E0(DTD_END_INTERNAL,
                    LOC("dtd-int-empty.xml", 1, 14)
            ),
            E0(DTD_END,
                    LOC("dtd-int-empty.xml", 1, 16)
            ),
            EV(STAG,
                    LOC("dtd-int-empty.xml", 2, 1),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("dtd-int-empty.xml", 2, 3)
            ),
            END,
        },
    },
    {
        TC("Invalid parameter entity reference"),
        .input = "entities01.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(DTD_BEGIN,
                    LOC("entities01.xml", 1, 1),
                    .root = TOK("a"),
            ),
            EV(ENTITY_DEF,
                    LOC("entities01.xml", 2, 1),
                    .type = XML_READER_REF_PE_INTERNAL,
                    .name = TOK("bar"),
                    .text = TOK("b"),
            ),
            EV(MESSAGE,
                    LOC("entities01.xml", 3, 16),
                    .info = XMLERR(ERROR, XML, P_PEReference),
                    .msg = "Reference to parameter entity is forbidden here",
            ),
            EV(ENTITY_DEF,
                    LOC("entities01.xml", 3, 1),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("foo"),
                    .text = TOK("ac"),
            ),
            E0(DTD_END_INTERNAL,
                    LOC("entities01.xml", 4, 1)
            ),
            E0(DTD_END,
                    LOC("entities01.xml", 4, 3)
            ),
            EV(STAG,
                    LOC("entities01.xml", 5, 1),
                    .name = TOK("a"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("entities01.xml", 5, 4),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("foo"),
            ),
            EV(ENTITY_PARSE_END,
                    LOC("entities01.xml", 5, 4),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("foo"),
            ),
            EV(TEXT,
                    LOC("entities01.xml", 5, 4),
                    .text = TOK("ac"),
                    .ws = false,
            ),
            EV(ETAG,
                    LOC("entities01.xml", 5, 9),
                    .name = TOK("a"),
            ),
            END,
        },
    },
    {
        TC("Character/entity reference to closing quote"),
        .input = "entities02.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(DTD_BEGIN,
                    LOC("entities02.xml", 1, 1),
                    .root = TOK("a"),
            ),
            EV(ENTITY_DEF,
                    LOC("entities02.xml", 2, 1),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("bar"),
                    .text = TOK("\">"),
            ),
            EV(ENTITY_DEF,
                    LOC("entities02.xml", 3, 1),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("baz"),
                    .text = TOK("&quot;>"),
            ),
            EV(ENTITY_DEF,
                    LOC("entities02.xml", 4, 1),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("foo1"),
                    .text = TOK("a&bar;b"),
            ),
            EV(ENTITY_DEF,
                    LOC("entities02.xml", 5, 1),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("foo2"),
                    .text = TOK("a&baz;b"),
            ),
            E0(DTD_END_INTERNAL,
                    LOC("entities02.xml", 6, 1)
            ),
            E0(DTD_END,
                    LOC("entities02.xml", 6, 3)
            ),
            EV(STAG,
                    LOC("entities02.xml", 7, 1),
                    .name = TOK("a"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("entities02.xml", 7, 11),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("foo1"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("entity(foo1)", 1, 2),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("bar"),
            ),
            EV(ENTITY_PARSE_END,
                    LOC("entity(foo1)", 1, 2),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("bar"),
            ),
            EV(ENTITY_PARSE_END,
                    LOC("entities02.xml", 7, 11),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("foo1"),
            ),
            EV(ATTR,
                    LOC("entities02.xml", 7, 4),
                    .name = TOK("attr1"),
                    .value = TOK("a\">b"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("entities02.xml", 7, 26),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("foo2"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("entity(foo2)", 1, 2),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("baz"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("entity(baz)", 1, 1),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("quot"),
            ),
            EV(ENTITY_PARSE_END,
                    LOC("entity(baz)", 1, 1),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("quot"),
            ),
            EV(ENTITY_PARSE_END,
                    LOC("entity(foo2)", 1, 2),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("baz"),
            ),
            EV(ENTITY_PARSE_END,
                    LOC("entities02.xml", 7, 26),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("foo2"),
            ),
            EV(ATTR,
                    LOC("entities02.xml", 7, 19),
                    .name = TOK("attr2"),
                    .value = TOK("a\">b"),
            ),
            E0(ETAG,
                    LOC("entities02.xml", 7, 33)
            ),
            END,
        },
    },
    {
        TC("Start tag crossing entity boundary"),
        .input = "entities03.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(DTD_BEGIN,
                    LOC("entities03.xml", 1, 1),
                    .root = TOK("a"),
            ),
            EV(ENTITY_DEF,
                    LOC("entities03.xml", 2, 1),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("x"),
                    .text = TOK("<a attr=\"foo"),
            ),
            EV(ENTITY_DEF,
                    LOC("entities03.xml", 3, 1),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("y"),
                    .text = TOK("<a>&x;\"/></a>"),
            ),
            E0(DTD_END_INTERNAL,
                    LOC("entities03.xml", 4, 1)
            ),
            E0(DTD_END,
                    LOC("entities03.xml", 4, 3)
            ),
            EV(STAG,
                    LOC("entities03.xml", 5, 1),
                    .name = TOK("a"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("entities03.xml", 5, 4),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("y"),
            ),
            EV(STAG,
                    LOC("entity(y)", 1, 1),
                    .name = TOK("a"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("entity(y)", 1, 4),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("x"),
            ),
            EV(STAG,
                    LOC("entity(x)", 1, 1),
                    .name = TOK("a"),
            ),
            EV(MESSAGE,
                    LOC("entity(x)", 1, 9),
                    .info = XMLERR(ERROR, XML, P_AttValue),
                    .msg = "Unterminated literal",
            ),
            EV(ENTITY_PARSE_END,
                    LOC("entity(y)", 1, 4),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("x"),
            ),
#if 0 // TBD breaklockrework
            EV(TEXT,
                    LOC("entity(y)", 1, 7),
                    .text = TOK("\"/>"),
                    .ws = false,
            ),
            EV(ETAG,
                    LOC("entity(y)", 1, 10),
                    .name = TOK("a"),
            ),
#endif
            EV(ENTITY_PARSE_END,
                    LOC("entities03.xml", 5, 4),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("y"),
            ),
#if 0 // TBD breaklockrework
            EV(ETAG,
                    LOC("entities03.xml", 5, 7),
                    .name = TOK("a"),
            ),
#endif
            END,
        },
    },
    {
        TC("Entity reference crossing entity boundary"),
        .input = "entities04.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(DTD_BEGIN,
                    LOC("entities04.xml", 1, 1),
                    .root = TOK("a"),
            ),
            EV(ENTITY_DEF,
                    LOC("entities04.xml", 2, 1),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("x"),
                    .text = TOK("foo"),
            ),
            EV(ENTITY_DEF,
                    LOC("entities04.xml", 3, 1),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("y"),
                    .text = TOK("&"),
            ),
            EV(ENTITY_DEF,
                    LOC("entities04.xml", 4, 1),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("z"),
                    .text = TOK("&y;x;"),
            ),
            E0(DTD_END_INTERNAL,
                    LOC("entities04.xml", 5, 1)
            ),
            E0(DTD_END,
                    LOC("entities04.xml", 5, 3)
            ),
            EV(STAG,
                    LOC("entities04.xml", 6, 1),
                    .name = TOK("a"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("entities04.xml", 6, 4),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("z"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("entity(z)", 1, 1),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("y"),
            ),
            EV(MESSAGE,
                    LOC("entity(y)", 1, 1),
                    .info = XMLERR(ERROR, XML, P_Reference),
                    .msg = "Malformed unknown reference",
            ),
            EV(ENTITY_PARSE_END,
                    LOC("entity(z)", 1, 1),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("y"),
            ),
            EV(ENTITY_PARSE_END,
                    LOC("entities04.xml", 6, 4),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("z"),
            ),
            EV(TEXT,
                    LOC("entities04.xml", 6, 4),
                    .text = TOK("x;"),
                    .ws = false,
            ),
            EV(ETAG,
                    LOC("entities04.xml", 6, 7),
                    .name = TOK("a"),
            ),
            END,
        },
    },
    {
        TC("Entities with system and public IDs"),
        .input = "entities05.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(DTD_BEGIN,
                    LOC("entities05.xml", 1, 1),
                    .root = TOK("elem"),
            ),
            EV(ENTITY_DEF,
                    LOC("entities05.xml", 2, 1),
                    .type = XML_READER_REF_EXTERNAL,
                    .name = TOK("foo"),
                    .system_id = TOK("xxx.xml"),
            ),
            EV(ENTITY_DEF,
                    LOC("entities05.xml", 3, 1),
                    .type = XML_READER_REF_EXTERNAL,
                    .name = TOK("bar"),
                    .public_id = TOK("-//PubId/Entity"),
                    .system_id = TOK("yyy.xml"),
            ),
            E0(DTD_END_INTERNAL,
                    LOC("entities05.xml", 4, 1)
            ),
            E0(DTD_END,
                    LOC("entities05.xml", 4, 3)
            ),
            EV(STAG,
                    LOC("entities05.xml", 5, 1),
                    .name = TOK("elem"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("entities05.xml", 6, 9),
                    .type = XML_READER_REF_EXTERNAL,
                    .name = TOK("foo"),
                    .system_id = TOK("xxx.xml"),
            ),
            EV(MESSAGE,
                    LOC("entities05.xml", 6, 14),
                    .info = XMLERR(ERROR, XML, ENTITY_LOAD_FAILURE),
                    .msg = "Entity failed to load: xxx.xml",
            ),
            EV(ENTITY_NOT_LOADED,
                    LOC("entities05.xml", 6, 9),
                    .type = XML_READER_REF_EXTERNAL,
                    .name = TOK("foo"),
                    .system_id = TOK("xxx.xml"),
            ),
            EV(ENTITY_PARSE_END,
                    LOC("entities05.xml", 6, 9),
                    .type = XML_READER_REF_EXTERNAL,
                    .name = TOK("foo"),
                    .system_id = TOK("xxx.xml"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("entities05.xml", 7, 9),
                    .type = XML_READER_REF_EXTERNAL,
                    .name = TOK("bar"),
                    .system_id = TOK("yyy.xml"),
                    .public_id = TOK("-//PubId/Entity"),
            ),
            EV(MESSAGE,
                    LOC("entities05.xml", 7, 14),
                    .info = XMLERR(ERROR, XML, ENTITY_LOAD_FAILURE),
                    .msg = "Entity failed to load: yyy.xml",
            ),
            EV(ENTITY_NOT_LOADED,
                    LOC("entities05.xml", 7, 9),
                    .type = XML_READER_REF_EXTERNAL,
                    .name = TOK("bar"),
                    .system_id = TOK("yyy.xml"),
                    .public_id = TOK("-//PubId/Entity"),
            ),
            EV(ENTITY_PARSE_END,
                    LOC("entities05.xml", 7, 9),
                    .type = XML_READER_REF_EXTERNAL,
                    .name = TOK("bar"),
                    .system_id = TOK("yyy.xml"),
                    .public_id = TOK("-//PubId/Entity"),
            ),
            EV(TEXT,
                    LOC("entities05.xml", 5, 7),
                    .text = TOK("\n\t\n\t\n"),
                    .ws = true,
            ),
            EV(ETAG,
                    LOC("entities05.xml", 8, 1),
                    .name = TOK("elem"),
            ),
            END,
        },
    },
    {
        TC("Improper nesting of start/end tag in entity #2"),
        .input = "entities06.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(DTD_BEGIN,
                    LOC("entities06.xml", 1, 1),
                    .root = TOK("foo"),
            ),
            EV(ENTITY_DEF,
                    LOC("entities06.xml", 2, 1),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("x"),
                    .text = TOK("<bar>baz</bar></foo>"),
            ),
            E0(DTD_END_INTERNAL,
                    LOC("entities06.xml", 3, 1)
            ),
            E0(DTD_END,
                    LOC("entities06.xml", 3, 3)
            ),
            EV(STAG,
                    LOC("entities06.xml", 4, 1),
                    .name = TOK("foo"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("entities06.xml", 4, 11),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("x"),
            ),
            EV(TEXT,
                    LOC("entities06.xml", 4, 6),
                    .text = TOK("Text "),
                    .ws = false,
            ),
            EV(STAG,
                    LOC("entity(x)", 1, 1),
                    .name = TOK("bar"),
            ),
            EV(TEXT,
                    LOC("entity(x)", 1, 6),
                    .text = TOK("baz"),
                    .ws = false,
            ),
            EV(ETAG,
                    LOC("entity(x)", 1, 9),
                    .name = TOK("bar"),
            ),
            EV(ETAG,
                    LOC("entity(x)", 1, 15),
                    .name = TOK("foo"),
            ),
            EV(MESSAGE,
                    LOC("entity(x)", 1, 15),
                    .info = XMLERR(ERROR, XML, P_content),
                    .msg = "Replacement text for an entity must match 'content' production",
            ),
            EV(ENTITY_PARSE_END,
                    LOC("entities06.xml", 4, 11),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("x"),
            ),
            END,
        },
    },
    {
        TC("Improper nesting of start/end tag in entity #3"),
        .input = "entities07.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(DTD_BEGIN,
                    LOC("entities07.xml", 1, 1),
                    .root = TOK("foo"),
            ),
            EV(ENTITY_DEF,
                    LOC("entities07.xml", 2, 1),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("x"),
                    .text = TOK("<bar>baz"),
            ),
            E0(DTD_END_INTERNAL,
                    LOC("entities07.xml", 3, 1)
            ),
            E0(DTD_END,
                    LOC("entities07.xml", 3, 3)
            ),
            EV(STAG,
                    LOC("entities07.xml", 4, 1),
                    .name = TOK("foo"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("entities07.xml", 4, 11),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("x"),
            ),
            EV(TEXT,
                    LOC("entities07.xml", 4, 6),
                    .text = TOK("Text "),
                    .ws = false,
            ),
            EV(STAG,
                    LOC("entity(x)", 1, 1),
                    .name = TOK("bar"),
            ),
            EV(TEXT,
                    LOC("entity(x)", 1, 6),
                    .text = TOK("baz"),
                    .ws = false,
            ),
            EV(MESSAGE,
                    LOC("entity(x)", 1, 9),
                    .info = XMLERR(ERROR, XML, P_content),
                    .msg = "Replacement text for an entity must match 'content' production",
            ),
            EV(ENTITY_PARSE_END,
                    LOC("entities07.xml", 4, 11),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("x"),
            ),
            EV(ETAG,
                    LOC("entities07.xml", 4, 14),
                    .name = TOK("bar"),
            ),
            EV(ETAG,
                    LOC("entities07.xml", 4, 20),
                    .name = TOK("foo"),
            ),
            END,
        },
    },
    {
        TC("Mix of external/internal entity references"),
        .input = "entities08.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(DTD_BEGIN,
                    LOC("entities08.xml", 1, 1),
                    .root = TOK("a"),
            ),
            EV(ENTITY_DEF,
                    LOC("entities08.xml", 2, 1),
                    .type = XML_READER_REF_EXTERNAL,
                    .name = TOK("foo"),
                    .system_id = TOK("entities08-2.xml"),
            ),
            EV(ENTITY_DEF,
                    LOC("entities08.xml", 3, 1),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("bar"),
                    .text = TOK("BAR"),
            ),
            E0(DTD_END_INTERNAL,
                    LOC("entities08.xml", 4, 1)
            ),
            E0(DTD_END,
                    LOC("entities08.xml", 4, 3)
            ),
            EV(STAG,
                    LOC("entities08.xml", 5, 1),
                    .name = TOK("a"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("entities08.xml", 5, 4),
                    .type = XML_READER_REF_EXTERNAL,
                    .name = TOK("foo"),
                    .system_id = TOK("entities08-2.xml"),
            ),
            EV(STAG,
                    LOC("entities08-2.xml", 1, 1),
                    .name = TOK("foo"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("entities08-2.xml", 1, 6),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("bar"),
            ),
            EV(ENTITY_PARSE_END,
                    LOC("entities08-2.xml", 1, 6),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("bar"),
            ),
            EV(TEXT,
                    LOC("entities08-2.xml", 1, 6),
                    .text = TOK("BAR"),
                    .ws = false,
            ),
            EV(ETAG,
                    LOC("entities08-2.xml", 1, 11),
                    .name = TOK("foo"),
            ),
            EV(ENTITY_PARSE_END,
                    LOC("entities08.xml", 5, 4),
                    .type = XML_READER_REF_EXTERNAL,
                    .name = TOK("foo"),
                    .system_id = TOK("entities08-2.xml"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("entities08.xml", 5, 9),
                    .type = XML_READER_REF_EXTERNAL,
                    .name = TOK("foo"),
                    .system_id = TOK("entities08-2.xml"),
            ),
            EV(TEXT,
                    LOC("entities08-2.xml", 1, 17),
                    .text = TOK("\n"),
                    .ws = true,
            ),
            EV(STAG,
                    LOC("entities08-2.xml", 1, 1),
                    .name = TOK("foo"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("entities08-2.xml", 1, 6),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("bar"),
            ),
            EV(ENTITY_PARSE_END,
                    LOC("entities08-2.xml", 1, 6),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("bar"),
            ),
            EV(TEXT,
                    LOC("entities08-2.xml", 1, 6),
                    .text = TOK("BAR"),
                    .ws = false,
            ),
            EV(ETAG,
                    LOC("entities08-2.xml", 1, 11),
                    .name = TOK("foo"),
            ),
            EV(ENTITY_PARSE_END,
                    LOC("entities08.xml", 5, 9),
                    .type = XML_READER_REF_EXTERNAL,
                    .name = TOK("foo"),
                    .system_id = TOK("entities08-2.xml"),
            ),
            EV(TEXT,
                    LOC("entities08-2.xml", 1, 17),
                    .text = TOK("\n"),
                    .ws = true,
            ),
            EV(ETAG,
                    LOC("entities08.xml", 5, 14),
                    .name = TOK("a"),
            ),
            END,
        },
    },
    {
        TC("Mix of external/internal entity references"),
        .input = "entities09.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(DTD_BEGIN,
                    LOC("entities09.xml", 1, 1),
                    .root = TOK("a"),
            ),
            EV(NOTATION_DEF,
                    LOC("entities09.xml", 2, 1),
                    .name = TOK("bar"),
                    .system_id = TOK("http://bar.org/def.xml"),
            ),
            EV(ENTITY_DEF,
                    LOC("entities09.xml", 3, 1),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("b"),
                    .text = TOK("&foo;"),
            ),
            EV(ENTITY_DEF,
                    LOC("entities09.xml", 4, 1),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("foo"),
                    .text = TOK("xxx"),
            ),
            EV(ENTITY_DEF,
                    LOC("entities09.xml", 5, 1),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("c"),
                    .text = TOK("&bar;"),
            ),
            EV(MESSAGE,
                    LOC("entities09.xml", 6, 40),
                    .info = XMLERR(ERROR, XML, P_EntityRef),
                    .msg = "Unparsed entity referenced from another entity value",
            ),
            EV(MESSAGE,
                    LOC("entities09.xml", 5, 1),
                    .info = XMLERR_NOTE,
                    .msg = "This is the location of the reference",
            ),
            EV(ENTITY_DEF,
                    LOC("entities09.xml", 6, 1),
                    .type = XML_READER_REF_UNPARSED,
                    .name = TOK("bar"),
                    .system_id = TOK("bar.exe"),
                    .ndata = TOK("bar"),
                    .nsystem_id = TOK("http://bar.org/def.xml"),
            ),
            EV(MESSAGE,
                    LOC("entities09.xml", 7, 13),
                    .info = XMLERR(ERROR, XML, P_EntityRef),
                    .msg = "external unparsed general entity reference here is an error",
            ),
            EV(ENTITY_DEF,
                    LOC("entities09.xml", 7, 1),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("d"),
                    .text = TOK("&bar;"),
            ),
            EV(ENTITY_DEF,
                    LOC("entities09.xml", 8, 1),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("e"),
                    .text = TOK("&baz;"),
            ),
            E0(DTD_END_INTERNAL,
                    LOC("entities09.xml", 9, 1)
            ),
            EV(MESSAGE,
                    LOC("entities09.xml", 8, 1),
                    .info = XMLERR(WARN, XML, P_EntityRef),
                    .msg = "Entity 'baz' referenced here is not defined "
                "(would be error if this entity is defined as unparsed)",
            ),
            E0(DTD_END,
                    LOC("entities09.xml", 9, 3)
            ),
            EV(STAG,
                    LOC("entities09.xml", 10, 1),
                    .name = TOK("a"),
            ),
            EV(STAG,
                    LOC("entities09.xml", 10, 4),
                    .name = TOK("x"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("entities09.xml", 10, 7),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("b"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("entity(b)", 1, 1),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("foo"),
            ),
            EV(ENTITY_PARSE_END,
                    LOC("entity(b)", 1, 1),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("foo"),
            ),
            EV(ENTITY_PARSE_END,
                    LOC("entities09.xml", 10, 7),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("b"),
            ),
            EV(TEXT,
                    LOC("entities09.xml", 10, 7),
                    .text = TOK("xxx"),
                    .ws = false,
            ),
            EV(ETAG,
                    LOC("entities09.xml", 10, 10),
                    .name = TOK("x"),
            ),
            EV(STAG,
                    LOC("entities09.xml", 10, 14),
                    .name = TOK("x"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("entities09.xml", 10, 17),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("c"),
            ),
            EV(MESSAGE,
                    LOC("entity(c)", 1, 1),
                    .info = XMLERR(ERROR, XML, P_EntityRef),
                    .msg = "Reference to external unparsed general entity is forbidden here",
            ),
            EV(ENTITY_PARSE_END,
                    LOC("entities09.xml", 10, 17),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("c"),
            ),
            EV(ETAG,
                    LOC("entities09.xml", 10, 20),
                    .name = TOK("x"),
            ),
            EV(STAG,
                    LOC("entities09.xml", 10, 24),
                    .name = TOK("x"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("entities09.xml", 10, 27),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("d"),
            ),
            EV(MESSAGE,
                    LOC("entity(d)", 1, 1),
                    .info = XMLERR(ERROR, XML, P_EntityRef),
                    .msg = "Reference to external unparsed general entity is forbidden here",
            ),
            EV(ENTITY_PARSE_END,
                    LOC("entities09.xml", 10, 27),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("d"),
            ),
            EV(ETAG,
                    LOC("entities09.xml", 10, 30),
                    .name = TOK("x"),
            ),
            EV(STAG,
                    LOC("entities09.xml", 10, 34),
                    .name = TOK("x"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("entities09.xml", 10, 37),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("e"),
            ),
            EV(ENTITY_UNKNOWN,
                    LOC("entity(e)", 1, 1),
                    .type = XML_READER_REF_GENERAL,
                    .name = TOK("baz"),
            ),
            EV(ENTITY_PARSE_END,
                    LOC("entities09.xml", 10, 37),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("e"),
            ),
            EV(ETAG,
                    LOC("entities09.xml", 10, 40),
                    .name = TOK("x"),
            ),
            EV(ETAG,
                    LOC("entities09.xml", 10, 44),
                    .name = TOK("a"),
            ),
            END,
        },
    },
    {
        TC("Notations in PIs and entities"),
        .input = "notation.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(DTD_BEGIN,
                    LOC("notation.xml", 1, 1),
                    .root = TOK("zzz"),
            ),
            EV(NOTATION_DEF,
                    LOC("notation.xml", 2, 1),
                    .name = TOK("notated-pi1"),
                    .system_id = TOK("pi1.exe"),
            ),
            EV(NOTATION_DEF,
                    LOC("notation.xml", 3, 1),
                    .name = TOK("notated-pi2"),
                    .public_id = TOK("-//Owner//Public PI 2//EN"),
                    .system_id = TOK("pi2.exe"),
            ),
            EV(NOTATION_DEF,
                    LOC("notation.xml", 4, 1),
                    .name = TOK("notated-pi3"),
                    .public_id = TOK("-//Owner//Public PI 3//EN"),
            ),
            EV(NOTATION_DEF,
                    LOC("notation.xml", 5, 1),
                    .name = TOK("uent"),
                    .public_id = TOK("-//Owner//Unparsed entity handler//EN"),
                    .system_id = TOK("uent.exe"),
            ),
            EV(ENTITY_DEF,
                    LOC("notation.xml", 6, 1),
                    .type = XML_READER_REF_UNPARSED,
                    .name = TOK("unparsed1"),
                    .system_id = TOK("uent1.pdf"),
                    .ndata = TOK("uent"),
                    .nsystem_id = TOK("uent.exe"),
                    .npublic_id = TOK("-//Owner//Unparsed entity handler//EN"),
            ),
            EV(ENTITY_DEF,
                    LOC("notation.xml", 7, 1),
                    .type = XML_READER_REF_UNPARSED,
                    .name = TOK("unparsed2"),
                    .public_id = TOK("-//Owner/UENT//EN"),
                    .system_id = TOK("uent2.pdf"),
                    .ndata = TOK("uent"),
                    .nsystem_id = TOK("uent.exe"),
                    .npublic_id = TOK("-//Owner//Unparsed entity handler//EN"),
            ),
            E0(DTD_END_INTERNAL,
                    LOC("notation.xml", 8, 1)
            ),
            E0(DTD_END,
                    LOC("notation.xml", 8, 3)
            ),
            EV(STAG,
                    LOC("notation.xml", 9, 1),
                    .name = TOK("z"),
            ),
            EV(TEXT,
                    LOC("notation.xml", 9, 4),
                    .text = TOK("\n  "),
                    .ws = true,
            ),
            EV(PI,
                    LOC("notation.xml", 10, 3),
                    .target = TOK("notated-pi1"),
                    .nsystem_id = TOK("pi1.exe"),
            ),
            EV(TEXT,
                    LOC("notation.xml", 10, 18),
                    .text = TOK("\n  "),
                    .ws = true,
            ),
            EV(PI,
                    LOC("notation.xml", 11, 3),
                    .target = TOK("notated-pi2"),
                    .nsystem_id = TOK("pi2.exe"),
                    .npublic_id = TOK("-//Owner//Public PI 2//EN"),
            ),
            EV(TEXT,
                    LOC("notation.xml", 11, 18),
                    .text = TOK("\n  "),
                    .ws = true,
            ),
            EV(PI,
                    LOC("notation.xml", 12, 3),
                    .target = TOK("notated-pi3"),
                    .npublic_id = TOK("-//Owner//Public PI 3//EN"),
            ),
            EV(TEXT,
                    LOC("notation.xml", 12, 18),
                    .text = TOK("\n  "),
                    .ws = true,
            ),
            EV(PI,
                    LOC("notation.xml", 13, 3),
                    .target = TOK("non-notated-pi"),
            ),
            EV(TEXT,
                    LOC("notation.xml", 13, 21),
                    .text = TOK("\n"),
                    .ws = true,
            ),
            EV(ETAG,
                    LOC("notation.xml", 14, 1),
                    .name = TOK("z"),
            ),
            END,
        },
    },
    {
        TC("Denormalized XML 1.0 document"),
        .input = "denorm01.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(STAG,
                    LOC("denorm01.xml", 1, 1),
                    .name = TOK("a"),
            ),
            EV(TEXT,
                    LOC("denorm01.xml", 1, 4),
                    .text = TOK("e\xCC\x80"),
                    .ws = false,
            ),
            EV(ETAG,
                    LOC("denorm01.xml", 1, 5),
                    .name = TOK("a"),
            ),
            END,
        }
    },
    {
        TC("Denormalized XML 1.1 document: not Unicode-normalized"),
        .input = "denorm02.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(XMLDECL,
                    LOC("denorm02.xml", 1, 20),
                    .encoding = NULL,
                    .standalone = XML_INFO_STANDALONE_NO_VALUE,
                    .version = XML_INFO_VERSION_1_1,
            ),
            EV(STAG,
                    LOC("denorm02.xml", 2, 1),
                    .name = TOK("a"),
            ),
            EV(MESSAGE,
                    LOC("denorm02.xml", 2, 5),
                    .info = XMLERR(WARN, XML, NORMALIZATION),
                    .msg = "Input is not Unicode-normalized",
            ),
            EV(TEXT,
                    LOC("denorm02.xml", 2, 4),
                    .text = TOK("e\xCC\x80"),
                    .ws = false,
            ),
            EV(ETAG,
                    LOC("denorm02.xml", 2, 5),
                    .name = TOK("a"),
            ),
            END,
        }
    },
    {
        TC("Denormalized XML 1.1 document: not include-normalized"),
        .input = "denorm03.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(XMLDECL,
                    LOC("denorm03.xml", 1, 20),
                    .encoding = NULL,
                    .standalone = XML_INFO_STANDALONE_NO_VALUE,
                    .version = XML_INFO_VERSION_1_1,
            ),
            EV(STAG,
                    LOC("denorm03.xml", 2, 1),
                    .name = TOK("a"),
            ),
            EV(MESSAGE,
                    LOC("denorm03.xml", 2, 13),
                    .info = XMLERR(WARN, XML, NORMALIZATION),
                    .msg = "Input is not include-normalized",
            ),
            EV(TEXT,
                    LOC("denorm03.xml", 2, 4),
                    .text = TOK("e\xCC\x80"),
                    .ws = false,
            ),
            EV(ETAG,
                    LOC("denorm03.xml", 2, 13),
                    .name = TOK("a"),
            ),
            END,
        }
    },
    {
        TC("Denormalized XML 1.1 document: relevant construct (Name) begins with composing character"),
        .input = "denorm04.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(XMLDECL,
                    LOC("denorm04.xml", 1, 20),
                    .encoding = NULL,
                    .standalone = XML_INFO_STANDALONE_NO_VALUE,
                    .version = XML_INFO_VERSION_1_1,
            ),
            EV(MESSAGE,
                    LOC("denorm04.xml", 2, 2),
                    .info = XMLERR(WARN, XML, NORMALIZATION),
                    .msg = "Relevant construct (Name) begins with a composing character",
            ),
            EV(STAG,
                    LOC("denorm04.xml", 2, 1),
                    .name = TOK("\xD2\x83"),
            ),
            E0(ETAG,
                    LOC("denorm04.xml", 2, 2)
            ),
            EV(MESSAGE,
                    LOC("denorm04.xml", 3, 3),
                    .info = XMLERR(WARN, XML, NORMALIZATION),
                    .msg = "Relevant construct (Name) begins with a composing character",
            ),
            EV(PI,
                    LOC("denorm04.xml", 3, 1),
                    .target = TOK("\xE0\xA6\xBE"),
            ),
            END,
        }
    },
    {
        TC("Denormalized XML 1.1 document: not include-normalized & relevant construct"
                " (CharData) begins with composing character"),
        .input = "denorm05.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(XMLDECL,
                    LOC("denorm05.xml", 1, 20),
                    .encoding = NULL,
                    .standalone = XML_INFO_STANDALONE_NO_VALUE,
                    .version = XML_INFO_VERSION_1_1,
            ),
            EV(DTD_BEGIN,
                    LOC("denorm05.xml", 2, 1),
                    .root = TOK("a"),
            ),
            EV(ENTITY_DEF,
                    LOC("denorm05.xml", 2, 14),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("empty"),
                    .text = TOK(""),
            ),
            E0(DTD_END_INTERNAL,
                    LOC("denorm05.xml", 2, 32)
            ),
            E0(DTD_END,
                    LOC("denorm05.xml", 2, 34)
            ),
            EV(STAG,
                    LOC("denorm05.xml", 3, 1),
                    .name = TOK("a"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("denorm05.xml", 3, 5),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("empty"),
            ),
            EV(ENTITY_PARSE_END,
                    LOC("denorm05.xml", 3, 5),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("empty"),
            ),
            EV(MESSAGE,
                    LOC("denorm05.xml", 3, 12),
                    .info = XMLERR(WARN, XML, NORMALIZATION),
                    .msg = "Input is not include-normalized",
            ),
            EV(ENTITY_PARSE_START,
                    LOC("denorm05.xml", 3, 14),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("empty"),
            ),
            EV(ENTITY_PARSE_END,
                    LOC("denorm05.xml", 3, 14),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("empty"),
            ),
            EV(MESSAGE,
                    LOC("denorm05.xml", 3, 21),
                    .info = XMLERR(WARN, XML, NORMALIZATION),
                    .msg = "Relevant construct (CharData) begins with a composing character",
            ),
            EV(TEXT,
                    LOC("denorm05.xml", 3, 4),
                    .text = TOK("e\xCC\x80 .\xCC\x80"),
                    .ws = false,
            ),
            EV(STAG,
                    LOC("denorm05.xml", 3, 21),
                    .name = TOK("a"),
            ),
            EV(MESSAGE,
                    LOC("denorm05.xml", 3, 32),
                    .info = XMLERR(WARN, XML, NORMALIZATION),
                    .msg = "Relevant construct (CharData) begins with a composing character",
            ),
            EV(TEXT,
                    LOC("denorm05.xml", 3, 24),
                    .text = TOK("\xCC\x83"),
                    .ws = false,
            ),
            EV(ETAG,
                    LOC("denorm05.xml", 3, 32),
                    .name = TOK("a"),
            ),
            EV(ETAG,
                    LOC("denorm05.xml", 3, 36),
                    .name = TOK("a"),
            ),
            END,
        }
    },
    {
        TC("Denormalized XML 1.1 document: relevant construct"
                " (parsed entity) begins with composing character"),
        .input = "denorm06.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(XMLDECL,
                    LOC("denorm06.xml", 1, 20),
                    .encoding = NULL,
                    .standalone = XML_INFO_STANDALONE_NO_VALUE,
                    .version = XML_INFO_VERSION_1_1,
            ),
            EV(DTD_BEGIN,
                    LOC("denorm06.xml", 2, 1),
                    .root = TOK("a"),
            ),
            EV(MESSAGE,
                    LOC("denorm06.xml", 2, 35),
                    .info = XMLERR(WARN, XML, NORMALIZATION),
                    .msg = "Relevant construct (parsed entity value) begins "
                        "with a composing character",
            ),
            EV(ENTITY_DEF,
                    LOC("denorm06.xml", 2, 14),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("foo"),
                    .text = TOK("\xCC\xA2"),
            ),
            E0(DTD_END_INTERNAL,
                    LOC("denorm06.xml", 2, 37)
            ),
            E0(DTD_END,
                    LOC("denorm06.xml", 2, 39)
            ),
            EV(STAG,
                    LOC("denorm06.xml", 3, 1),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("denorm06.xml", 3, 3)
            ),
            END,
        },
    },
    {
        TC("Including 1.0 entity into 1.1 document checks include normalization"),
        .input = "denorm07.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(XMLDECL,
                    LOC("denorm07.xml", 1, 20),
                    .encoding = NULL,
                    .standalone = XML_INFO_STANDALONE_NO_VALUE,
                    .version = XML_INFO_VERSION_1_1,
            ),
            EV(DTD_BEGIN,
                    LOC("denorm07.xml", 2, 1),
                    .root = TOK("a"),
            ),
            EV(ENTITY_DEF,
                    LOC("denorm07.xml", 2, 14),
                    .type = XML_READER_REF_EXTERNAL,
                    .name = TOK("foo"),
                    .system_id = TOK("denorm07-2.xml"),
            ),
            E0(DTD_END_INTERNAL,
                    LOC("denorm07.xml", 2, 51)
            ),
            E0(DTD_END,
                    LOC("denorm07.xml", 2, 53)
            ),
            EV(STAG,
                    LOC("denorm07.xml", 3, 1),
                    .name = TOK("a"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("denorm07.xml", 3, 4),
                    .type = XML_READER_REF_EXTERNAL,
                    .name = TOK("foo"),
                    .system_id = TOK("denorm07-2.xml"),
            ),
            EV(ENTITY_PARSE_END,
                    LOC("denorm07.xml", 3, 4),
                    .type = XML_READER_REF_EXTERNAL,
                    .name = TOK("foo"),
                    .system_id = TOK("denorm07-2.xml"),
            ),
            EV(MESSAGE,
                    LOC("denorm07.xml", 3, 9),
                    .info = XMLERR(WARN, XML, NORMALIZATION),
                    .msg = "Input is not include-normalized",
            ),
            EV(TEXT,
                    LOC("denorm07.xml", 3, 4),
                    .text = TOK("A\xCC\x80"),
                    .ws = false,
            ),
            EV(ETAG,
                    LOC("denorm07.xml", 3, 9),
                    .name = TOK("a"),
            ),
            END,
        },
    },
    {
        TC("Examples from W3C Character Model for WWW1.0: Normalization (3.3.2)"),
        .input = "denorm-w3c.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(XMLDECL,
                    LOC("denorm-w3c.xml", 1, 20),
                    .encoding = NULL,
                    .standalone = XML_INFO_STANDALONE_NO_VALUE,
                    .version = XML_INFO_VERSION_1_1,
            ),
            EV(DTD_BEGIN,
                    LOC("denorm-w3c.xml", 2, 1),
                    .root = TOK("a"),
            ),
            EV(ENTITY_DEF,
                    LOC("denorm-w3c.xml", 3, 1),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("ccedil"),
                    .text = TOK("\xC3\xA7"),
            ),
            EV(MESSAGE,
                    LOC("denorm-w3c.xml", 4, 26),
                    .info = XMLERR(WARN, XML, NORMALIZATION),
                    .msg = "Relevant construct (parsed entity value) begins with a composing character",
            ),
            EV(ENTITY_DEF,
                    LOC("denorm-w3c.xml", 4, 1),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("cedilla"),
                    .text = TOK("\xCC\xA7"),
            ),
            EV(ENTITY_DEF,
                    LOC("denorm-w3c.xml", 5, 1),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("c"),
                    .text = TOK("c"),
            ),
            EV(ENTITY_DEF,
                    LOC("denorm-w3c.xml", 6, 1),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("b"),
                    .text = TOK("b"),
            ),
            E0(DTD_END_INTERNAL,
                    LOC("denorm-w3c.xml", 7, 1)
            ),
            E0(DTD_END,
                    LOC("denorm-w3c.xml", 7, 3)
            ),
            EV(STAG,
                    LOC("denorm-w3c.xml", 8, 1),
                    .name = TOK("a"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("denorm-w3c.xml", 14, 3),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("ccedil"),
            ),
            EV(ENTITY_PARSE_END,
                    LOC("denorm-w3c.xml", 14, 3),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("ccedil"),
            ),
            EV(TEXT,
                    LOC("denorm-w3c.xml", 8, 4),
                    .text = TOK("\n"
                    "su\xC3\xA7on\n"
                    "sub\xCC\xA7on\n"
                    "su\xC3\xA7on\n"
                    "sub\xCC\xA7on\n"
                    "sub\xCC\xA7on\n"
                    "su\xC3\xA7on\n"
                    "su"),
                    .ws = false,
            ),
            // TBD once CDSECT event is rolled into general text, this should be a part of the
            // above token.
            EV(CDSECT,
                    LOC("denorm-w3c.xml", 15, 3),
                    .text = TOK("\xC3\xA7on"),
                    .ws = false,
            ),
            EV(ENTITY_PARSE_START,
                    LOC("denorm-w3c.xml", 16, 3),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("b"),
            ),
            EV(ENTITY_PARSE_END,
                    LOC("denorm-w3c.xml", 16, 3),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("b"),
            ),
            EV(MESSAGE,
                    LOC("denorm-w3c.xml", 16, 6),
                    .info = XMLERR(WARN, XML, NORMALIZATION),
                    .msg = "Relevant construct (CharData) begins with a composing character",
            ),
            EV(ENTITY_PARSE_START,
                    LOC("denorm-w3c.xml", 17, 4),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("cedilla"),
            ),
            EV(MESSAGE,
                    LOC("entity(cedilla)", 1, 1),
                    .info = XMLERR(WARN, XML, NORMALIZATION),
                    .msg = "Relevant construct (CharData) begins with a composing character",
            ),
            EV(ENTITY_PARSE_END,
                    LOC("denorm-w3c.xml", 17, 4),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("cedilla"),
            ),
            EV(TEXT,
                    LOC("denorm-w3c.xml", 15, 18),
                    .text = TOK("\n"
                    "sub\xCC\xA7on\n"
                    "sub\xCC\xA7on\n"
                    "suc"),
                    .ws = false,
            ),
            EV(COMMENT,
                    LOC("denorm-w3c.xml", 18, 4),
                    .text = TOK("comment"),
            ),
            EV(MESSAGE,
                    LOC("denorm-w3c.xml", 18, 18),
                    .info = XMLERR(WARN, XML, NORMALIZATION),
                    .msg = "Relevant construct (CharData) begins with a composing character",
            ),
            EV(TEXT,
                    LOC("denorm-w3c.xml", 18, 18),
                    .text = TOK("\xCC\xA7on\nsub"),
                    .ws = false,
            ),
            EV(COMMENT,
                    LOC("denorm-w3c.xml", 19, 4),
                    .text = TOK("comment"),
            ),
            EV(MESSAGE,
                    LOC("denorm-w3c.xml", 19, 18),
                    .info = XMLERR(WARN, XML, NORMALIZATION),
                    .msg = "Relevant construct (CharData) begins with a composing character",
            ),
            EV(TEXT,
                    LOC("denorm-w3c.xml", 19, 18),
                    .text = TOK("\xCC\xA7on\nsuc"),
                    .ws = false,
            ),
            EV(STAG,
                    LOC("denorm-w3c.xml", 20, 4),
                    .name = TOK("em"),
            ),
            EV(MESSAGE,
                    LOC("denorm-w3c.xml", 20, 8),
                    .info = XMLERR(WARN, XML, NORMALIZATION),
                    .msg = "Relevant construct (CharData) begins with a composing character",
            ),
            EV(TEXT,
                    LOC("denorm-w3c.xml", 20, 8),
                    .text = TOK("\xCC\xA7"),
                    .ws = false,
            ),
            EV(ETAG,
                    LOC("denorm-w3c.xml", 20, 8),
                    .name = TOK("em"),
            ),
            EV(TEXT,
                    LOC("denorm-w3c.xml", 20, 13),
                    .text = TOK("on\nsub"),
                    .ws = false,
            ),
            EV(STAG,
                    LOC("denorm-w3c.xml", 21, 4),
                    .name = TOK("em"),
            ),
            EV(MESSAGE,
                    LOC("denorm-w3c.xml", 21, 8),
                    .info = XMLERR(WARN, XML, NORMALIZATION),
                    .msg = "Relevant construct (CharData) begins with a composing character",
            ),
            EV(TEXT,
                    LOC("denorm-w3c.xml", 21, 8),
                    .text = TOK("\xCC\xA7"),
                    .ws = false,
            ),
            EV(ETAG,
                    LOC("denorm-w3c.xml", 21, 8),
                    .name = TOK("em"),
            ),
            EV(TEXT,
                    LOC("denorm-w3c.xml", 21, 13),
                    .text = TOK("on\nsuc"),
                    .ws = false,
            ),
            EV(PI,
                    LOC("denorm-w3c.xml", 22, 4),
                    .target = TOK("proc-instr"),
            ),
            EV(MESSAGE,
                    LOC("denorm-w3c.xml", 22, 18),
                    .info = XMLERR(WARN, XML, NORMALIZATION),
                    .msg = "Relevant construct (CharData) begins with a composing character",
            ),
            EV(TEXT,
                    LOC("denorm-w3c.xml", 22, 18),
                    .text = TOK("\xCC\xA7on\nsub"),
                    .ws = false,
            ),
            EV(PI,
                    LOC("denorm-w3c.xml", 23, 4),
                    .target = TOK("proc-instr"),
            ),
            EV(MESSAGE,
                    LOC("denorm-w3c.xml", 23, 18),
                    .info = XMLERR(WARN, XML, NORMALIZATION),
                    .msg = "Relevant construct (CharData) begins with a composing character",
            ),
            EV(TEXT,
                    LOC("denorm-w3c.xml", 23, 18),
                    .text = TOK("\xCC\xA7on\nsub"),
                    .ws = false,
            ),
            EV(MESSAGE,
                    LOC("denorm-w3c.xml", 24, 13),
                    .info = XMLERR(WARN, XML, NORMALIZATION),
                    .msg = "Relevant construct (CData) begins with a composing character",
            ),
            EV(CDSECT,
                    LOC("denorm-w3c.xml", 24, 4),
                    .text = TOK("\xCC\xA7on"),
                    .ws = false,
            ),
            EV(ENTITY_PARSE_START,
                    LOC("denorm-w3c.xml", 25, 3),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("c"),
            ),
            EV(ENTITY_PARSE_END,
                    LOC("denorm-w3c.xml", 25, 3),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("c"),
            ),
            EV(MESSAGE,
                    LOC("denorm-w3c.xml", 25, 6),
                    .info = XMLERR(WARN, XML, NORMALIZATION),
                    .msg = "Input is not include-normalized",
            ),
            EV(MESSAGE,
                    LOC("denorm-w3c.xml", 26, 11),
                    .info = XMLERR(WARN, XML, NORMALIZATION),
                    .msg = "Input is not include-normalized",
            ),
            EV(MESSAGE,
                    LOC("denorm-w3c.xml", 27, 9),
                    .info = XMLERR(WARN, XML, NORMALIZATION),
                    .msg = "Input is not include-normalized",
            ),
            EV(ENTITY_PARSE_START,
                    LOC("denorm-w3c.xml", 28, 4),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("cedilla"),
            ),
            EV(MESSAGE,
                    LOC("entity(cedilla)", 1, 1),
                    .info = XMLERR(WARN, XML, NORMALIZATION),
                    .msg = "Input is not include-normalized",
            ),
            EV(ENTITY_PARSE_END,
                    LOC("denorm-w3c.xml", 28, 4),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("cedilla"),
            ),
            EV(TEXT,
                    LOC("denorm-w3c.xml", 24, 18),
                    .text = TOK("\n"
                    "suc\xCC\xA7on\n"
                    "suc\xCC\xA7on\n"
                    "suc\xCC\xA7on\n"
                    "suc\xCC\xA7on\n"
                    "suc"),
                    .ws = false,
            ),
            EV(MESSAGE,
                    LOC("denorm-w3c.xml", 29, 13),
                    .info = XMLERR(WARN, XML, NORMALIZATION),
                    .msg = "Input is not include-normalized",
            ),
            EV(CDSECT,
                    LOC("denorm-w3c.xml", 29, 4),
                    .text = TOK("\xCC\xA7on"),
                    .ws = false,
            ),
            EV(TEXT,
                    LOC("denorm-w3c.xml", 29, 18),
                    .text = TOK("\nsu"),
                    .ws = false,
            ),
            EV(CDSECT,
                    LOC("denorm-w3c.xml", 30, 3),
                    .text = TOK("c"),
                    .ws = false,
            ),
            EV(MESSAGE,
                    LOC("denorm-w3c.xml", 30, 16),
                    .info = XMLERR(WARN, XML, NORMALIZATION),
                    .msg = "Input is not include-normalized",
            ),
            EV(MESSAGE,
                    LOC("denorm-w3c.xml", 31, 4),
                    .info = XMLERR(WARN, XML, NORMALIZATION),
                    .msg = "Input is not Unicode-normalized",
            ),
            EV(TEXT,
                    LOC("denorm-w3c.xml", 30, 16),
                    .text = TOK("\xCC\xA7on\nsuc\xCC\xA7on\nsu\xC3\xA7"),
                    .ws = false,
            ),
            EV(STAG,
                    LOC("denorm-w3c.xml", 32, 4),
                    .name = TOK("em"),
            ),
            EV(MESSAGE,
                    LOC("denorm-w3c.xml", 32, 8),
                    .info = XMLERR(WARN, XML, NORMALIZATION),
                    .msg = "Input is not Unicode-normalized",
            ),
            EV(TEXT,
                    LOC("denorm-w3c.xml", 32, 8),
                    .text = TOK("\xCC\xB8"),
                    .ws = false,
            ),
            EV(ETAG,
                    LOC("denorm-w3c.xml", 32, 8),
                    .name = TOK("em"),
            ),
            EV(TEXT,
                    LOC("denorm-w3c.xml", 32, 13),
                    .text = TOK("\n"),
                    .ws = true,
            ),
            EV(ETAG,
                    LOC("denorm-w3c.xml", 33, 1),
                    .name = TOK("a"),
            ),
            END,
        }
    },
    {
        TC("Parameter entities mix #1"),
        .input = "pe.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(DTD_BEGIN,
                    LOC("pe.xml", 1, 1),
                    .root = TOK("a"),
                    .system_id = TOK("pe-1.dtd"),
            ),
            EV(ENTITY_DEF,
                    LOC("pe.xml", 2, 1),
                    .type = XML_READER_REF_PE_EXTERNAL,
                    .name = TOK("external1"),
                    .system_id = TOK("pe-2.dtd"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("pe.xml", 3, 1),
                    .type = XML_READER_REF_PE_EXTERNAL,
                    .name = TOK("external1"),
                    .system_id = TOK("pe-2.dtd"),
            ),
            EV(ENTITY_DEF,
                    LOC("pe-2.dtd", 1, 1),
                    .type = XML_READER_REF_PE_INTERNAL,
                    .name = TOK("text1"),
                    .text = TOK("some text"),
            ),
            EV(ENTITY_DEF,
                    LOC("pe-2.dtd", 2, 1),
                    .type = XML_READER_REF_PE_EXTERNAL,
                    .name = TOK("text2"),
                    .system_id = TOK("pe-text.dtd"),
            ),
            EV(ENTITY_PARSE_END,
                    LOC("pe.xml", 3, 1),
                    .type = XML_READER_REF_PE_EXTERNAL,
                    .name = TOK("external1"),
                    .system_id = TOK("pe-2.dtd"),
            ),
            EV(MESSAGE,
                    LOC("pe.xml", 4, 23),
                    .info = XMLERR(ERROR, XML, P_PEReference),
                    .msg = "Reference to parameter entity is forbidden here",
            ),
            EV(ENTITY_DEF,
                    LOC("pe.xml", 4, 1),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("element2"),
                    .text = TOK("<z></z> "),
            ),
            E0(DTD_END_INTERNAL,
                    LOC("pe.xml", 5, 1)
            ),
            EV(ENTITY_PARSE_START,
                    LOC("pe-1.dtd", 1, 22),
                    .type = XML_READER_REF_PE_INTERNAL,
                    .name = TOK("text1"),
            ),
            EV(ENTITY_PARSE_END,
                    LOC("pe-1.dtd", 1, 22),
                    .type = XML_READER_REF_PE_INTERNAL,
                    .name = TOK("text1"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("pe-1.dtd", 1, 36),
                    .type = XML_READER_REF_PE_EXTERNAL,
                    .name = TOK("text2"),
                    .system_id = TOK("pe-text.dtd"),
            ),
            EV(ENTITY_PARSE_END,
                    LOC("pe-1.dtd", 1, 36),
                    .type = XML_READER_REF_PE_EXTERNAL,
                    .name = TOK("text2"),
                    .system_id = TOK("pe-text.dtd"),
            ),
            EV(ENTITY_UNKNOWN,
                    LOC("pe-1.dtd", 1, 47),
                    .type = XML_READER_REF_PE,
                    .name = TOK("element2"),
            ),
            EV(ENTITY_DEF,
                    LOC("pe-1.dtd", 1, 1),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("element"),
                    .text = TOK("<b>some text</b><c>more text\n</c>&element2;"),
            ),
            E0(DTD_END,
                    LOC("pe.xml", 5, 3)
            ),
            EV(STAG,
                    LOC("pe.xml", 6, 1),
                    .name = TOK("a"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("pe.xml", 7, 2),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("element"),
            ),
            EV(TEXT,
                    LOC("pe.xml", 6, 4),
                    .text = TOK("\n "),
                    .ws = true,
            ),
            EV(STAG,
                    LOC("entity(element)", 1, 1),
                    .name = TOK("b"),
            ),
            EV(TEXT,
                    LOC("entity(element)", 1, 4),
                    .text = TOK("some text"),
                    .ws = false,
            ),
            EV(ETAG,
                    LOC("entity(element)", 1, 13),
                    .name = TOK("b"),
            ),
            EV(STAG,
                    LOC("entity(element)", 1, 17),
                    .name = TOK("c"),
            ),
            EV(TEXT,
                    LOC("entity(element)", 1, 20),
                    .text = TOK("more text\n"),
                    .ws = false,
            ),
            EV(ETAG,
                    LOC("entity(element)", 2, 1),
                    .name = TOK("c"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("entity(element)", 2, 5),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("element2"),
            ),
            EV(STAG,
                    LOC("entity(element2)", 1, 1),
                    .name = TOK("z"),
            ),
            EV(ETAG,
                    LOC("entity(element2)", 1, 4),
                    .name = TOK("z"),
            ),
            EV(ENTITY_PARSE_END,
                    LOC("entity(element)", 2, 5),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("element2"),
            ),
            EV(ENTITY_PARSE_END,
                    LOC("pe.xml", 7, 2),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("element"),
            ),
            EV(TEXT,
                    LOC("entity(element2)", 1, 8),
                    .text = TOK(" \n"),
                    .ws = true,
            ),
            EV(ETAG,
                    LOC("pe.xml", 8, 1),
                    .name = TOK("a"),
            ),
            END,
        },
    },
    {
        TC("Parameter entities mix #2 (parameter entities in literal)"),
        .input = "pe2.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(DTD_BEGIN,
                    LOC("pe2.xml", 1, 1),
                    .root = TOK("x"),
                    .system_id = TOK("pe2-1.dtd"),
            ),
            EV(ENTITY_DEF,
                    LOC("pe2-1.dtd", 1, 1),
                    .type = XML_READER_REF_PE_INTERNAL,
                    .name = TOK("qq1"),
                    .text = TOK("\""),
            ),
            EV(ENTITY_DEF,
                    LOC("pe2-1.dtd", 2, 1),
                    .type = XML_READER_REF_PE_EXTERNAL,
                    .name = TOK("qq2"),
                    .system_id = TOK("pe2-2.dtd"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("pe2-1.dtd", 3, 19),
                    .type = XML_READER_REF_PE_INTERNAL,
                    .name = TOK("qq1"),
            ),
            EV(ENTITY_PARSE_END,
                    LOC("pe2-1.dtd", 3, 19),
                    .type = XML_READER_REF_PE_INTERNAL,
                    .name = TOK("qq1"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("pe2-1.dtd", 3, 28),
                    .type = XML_READER_REF_PE_EXTERNAL,
                    .name = TOK("qq2"),
                    .system_id = TOK("pe2-2.dtd"),
            ),
            EV(ENTITY_PARSE_END,
                    LOC("pe2-1.dtd", 3, 28),
                    .type = XML_READER_REF_PE_EXTERNAL,
                    .name = TOK("qq2"),
                    .system_id = TOK("pe2-2.dtd"),
            ),
            EV(ENTITY_DEF,
                    LOC("pe2-1.dtd", 3, 1),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("foo"),
                    .text = TOK("test\"test\"\ntest"),
            ),
            E0(DTD_END,
                    LOC("pe2.xml", 1, 32)
            ),
            EV(STAG,
                    LOC("pe2.xml", 2, 1),
                    .name = TOK("x"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("pe2.xml", 2, 4),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("foo"),
            ),
            EV(ENTITY_PARSE_END,
                    LOC("pe2.xml", 2, 4),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("foo"),
            ),
            EV(TEXT,
                    LOC("pe2.xml", 2, 4),
                    .text = TOK("test\"test\"\ntest"),
                    .ws = false,
            ),
            EV(ETAG,
                    LOC("pe2.xml", 2, 9),
                    .name = TOK("x"),
            ),
            END,
        },
    },
    {
        TC("Very long entity name"),
        .input = "huge-entity-name.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(DTD_BEGIN,
                    LOC("huge-entity-name.xml", 1, 1),
                    .root = TOK("a"),
            ),
            EV(ENTITY_DEF,
                    LOC("huge-entity-name.xml", 2, 1),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK(VERY_LONG_NAME),
                    .text = TOK("replacement text"),
            ),
            E0(DTD_END_INTERNAL,
                    LOC("huge-entity-name.xml", 3, 1)
            ),
            E0(DTD_END,
                    LOC("huge-entity-name.xml", 3, 3)
            ),
            EV(STAG,
                    LOC("huge-entity-name.xml", 4, 1),
                    .name = TOK("a"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("huge-entity-name.xml", 4, 4),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK(VERY_LONG_NAME),
            ),
            EV(ENTITY_PARSE_END,
                    LOC("huge-entity-name.xml", 4, 4),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK(VERY_LONG_NAME),
            ),
            EV(TEXT,
                    LOC("huge-entity-name.xml", 4, 4),
                    .text = TOK("replacement text"),
                    .ws = false,
            ),
            EV(ETAG,
                    LOC("huge-entity-name.xml", 4, 1038),
                    .name = TOK("a"),
            ),
            END,
        },
    },
    {
        TC("Very long entity value"),
        .input = "huge-entity-value.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(DTD_BEGIN,
                    LOC("huge-entity-value.xml", 1, 1),
                    .root = TOK("a"),
            ),
            EV(ENTITY_DEF,
                    LOC("huge-entity-value.xml", 2, 1),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("foo"),
                    .text = TOK(VERY_LONG_NAME),
            ),
            E0(DTD_END_INTERNAL,
                    LOC("huge-entity-value.xml", 3, 1)
            ),
            E0(DTD_END,
                    LOC("huge-entity-value.xml", 3, 3)
            ),
            EV(STAG,
                    LOC("huge-entity-value.xml", 4, 1),
                    .name = TOK("a"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("huge-entity-value.xml", 4, 4),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("foo"),
            ),
            EV(ENTITY_PARSE_END,
                    LOC("huge-entity-value.xml", 4, 4),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("foo"),
            ),
            EV(TEXT,
                    LOC("huge-entity-value.xml", 4, 4),
                    .text = TOK(VERY_LONG_NAME),
                    .ws = false,
            ),
            EV(ETAG,
                    LOC("huge-entity-value.xml", 4, 9),
                    .name = TOK("a"),
            ),
            END,
        },
    },
    {
        TC("Malformed DTD #1"),
        .input = "dtd-bad1.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("dtd-bad1.xml", 1, 10),
                    .info = XMLERR(ERROR, XML, P_doctypedecl),
                    .msg = "Expect whitespace here",
            ),
            EV(MESSAGE,
                    LOC("dtd-bad1.xml", 1, 10),
                    .info = XMLERR(ERROR, XML, P_document),
                    .msg = "No root element",
            ),
            END,
        },
    },
    {
        TC("Malformed DTD #2"),
        .input = "dtd-bad2.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("dtd-bad2.xml", 1, 11),
                    .info = XMLERR(ERROR, XML, P_doctypedecl),
                    .msg = "Expect root element type here",
            ),
            EV(MESSAGE,
                    LOC("dtd-bad2.xml", 1, 11),
                    .info = XMLERR(ERROR, XML, P_document),
                    .msg = "No root element",
            ),
            END,
        },
    },
    {
        TC("Malformed DTD #3"),
        .input = "dtd-bad3.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(MESSAGE,
                    LOC("dtd-bad3.xml", 1, 19),
                    .info = XMLERR(ERROR, XML, P_ExternalID),
                    .msg = "Expect whitespace here",
            ),
            EV(MESSAGE,
                    LOC("dtd-bad3.xml", 1, 19),
                    .info = XMLERR(ERROR, XML, P_document),
                    .msg = "No root element",
            ),
            END,
        },
    },
    {
        TC("Malformed DTD #4"),
        .input = "dtd-bad4.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(DTD_BEGIN,
                    LOC("dtd-bad4.xml", 1, 1),
                    .root = TOK("a"),
            ),
            E0(DTD_END_INTERNAL,
                    LOC("dtd-bad4.xml", 1, 14)
            ),
            EV(MESSAGE,
                    LOC("dtd-bad4.xml", 1, 15),
                    .info = XMLERR(ERROR, XML, P_doctypedecl),
                    .msg = "Expected string: '>'",
            ),
            EV(STAG,
                    LOC("dtd-bad4.xml", 2, 1),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("dtd-bad4.xml", 2, 3)
            ),
            END,
        },
    },
    {
        TC("Malformed DTD #5"),
        .input = "dtd-bad5.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(DTD_BEGIN,
                    LOC("dtd-bad5.xml", 1, 1),
                    .root = TOK("a"),
            ),
            EV(MESSAGE,
                    LOC("dtd-bad5.xml", 2, 1),
                    .info = XMLERR(ERROR, XML, P_DeclSep),
                    .msg = "Invalid content in DTD",
            ),
            EV(MESSAGE,
                    LOC("dtd-bad5.xml", 3, 1),
                    .info = XMLERR(ERROR, XML, P_DeclSep),
                    .msg = "Invalid content in DTD",
            ),
            E0(DTD_END_INTERNAL,
                    LOC("dtd-bad5.xml", 4, 1)
            ),
            E0(DTD_END,
                    LOC("dtd-bad5.xml", 4, 3)
            ),
            EV(STAG,
                    LOC("dtd-bad5.xml", 5, 1),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("dtd-bad5.xml", 5, 3)
            ),
            END,
        },
    },
    {
        TC("Malformed notation declaration #1"),
        .input = "notation-bad1.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(DTD_BEGIN,
                    LOC("notation-bad1.xml", 1, 1),
                    .root = TOK("a"),
            ),
            EV(NOTATION_DEF,
                    LOC("notation-bad1.xml", 2, 1),
                    .name = TOK("first"),
                    .system_id = TOK("x.exe"),
            ),
            EV(MESSAGE,
                    LOC("notation-bad1.xml", 3, 11),
                    .info = XMLERR(ERROR, XML, P_NotationDecl),
                    .msg = "Expect whitespace here",
            ),
            EV(MESSAGE,
                    LOC("notation-bad1.xml", 4, 12),
                    .info = XMLERR(ERROR, XML, P_NotationDecl),
                    .msg = "Expect notation name here",
            ),
            EV(MESSAGE,
                    LOC("notation-bad1.xml", 5, 1),
                    .info = XMLERR(ERROR, XML, VC_UNIQUE_NOTATION_NAME),
                    .msg = "Given Name must not be declared in more than one notation declaration",
            ),
            EV(MESSAGE,
                    LOC("notation-bad1.xml", 6, 16),
                    .info = XMLERR(ERROR, XML, P_NotationDecl),
                    .msg = "Expect whitespace here",
            ),
            EV(MESSAGE,
                    LOC("notation-bad1.xml", 7, 17),
                    .info = XMLERR(ERROR, XML, P_NotationDecl),
                    .msg = "Expect ExternalID or PublicID here",
            ),
            EV(MESSAGE,
                    LOC("notation-bad1.xml", 8, 25),
                    .info = XMLERR(ERROR, XML, P_PubidLiteral),
                    .msg = "Quoted literal expected",
            ),
            EV(MESSAGE,
                    LOC("notation-bad1.xml", 9, 33),
                    .info = XMLERR(ERROR, XML, P_NotationDecl),
                    .msg = "Expected string: '>'",
            ),
            E0(DTD_END_INTERNAL,
                    LOC("notation-bad1.xml", 10, 1)
            ),
            E0(DTD_END,
                    LOC("notation-bad1.xml", 10, 3)
            ),
            EV(STAG,
                    LOC("notation-bad1.xml", 11, 1),
                    .name = TOK("a"),
            ),
            E0(ETAG,
                    LOC("notation-bad1.xml", 11, 3)
            ),
            END,
        },
    },
    {
        TC("Malformed entity declaration #1"),
        .input = "entity-bad1.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(DTD_BEGIN,
                    LOC("entity-bad1.xml", 1, 1),
                    .root = TOK("a"),
            ),
            EV(ENTITY_DEF,
                    LOC("entity-bad1.xml", 2, 1),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("first"),
                    .text = TOK("aaa"),
            ),
            EV(ENTITY_DEF,
                    LOC("entity-bad1.xml", 3, 1),
                    .type = XML_READER_REF_EXTERNAL,
                    .name = TOK("first.ext"),
                    .system_id = TOK("foo.xml"),
            ),
            EV(ENTITY_DEF,
                    LOC("entity-bad1.xml", 4, 1),
                    .type = XML_READER_REF_PE_EXTERNAL,
                    .name = TOK("first.param"),
                    .system_id = TOK("xxx.xml"),
            ),
            EV(MESSAGE,
                    LOC("entity-bad1.xml", 5, 9),
                    .info = XMLERR(ERROR, XML, P_EntityDecl),
                    .msg = "Expect whitespace here",
            ),
            EV(MESSAGE,
                    LOC("entity-bad1.xml", 6, 11),
                    .info = XMLERR(ERROR, XML, P_EntityDecl),
                    .msg = "Expect whitespace here",
            ),
            EV(MESSAGE,
                    LOC("entity-bad1.xml", 7, 10),
                    .info = XMLERR(ERROR, XML, P_EntityDecl),
                    .msg = "Expect entity name here",
            ),
            EV(MESSAGE,
                    LOC("entity-bad1.xml", 8, 1),
                    .info = XMLERR(WARN, XML, ENTITY_REDECLARED),
                    .msg = "Redefinition of an entity",
            ),
            EV(MESSAGE,
                    LOC("entity-bad1.xml", 2, 1),
                    .info = XMLERR_NOTE,
                    .msg = "This is the location of the previous definition",
            ),
            EV(MESSAGE,
                    LOC("entity-bad1.xml", 10, 1),
                    .info = XMLERR(WARN, XML, ENTITY_REDECLARED),
                    .msg = "Redefinition of an entity",
            ),
            EV(MESSAGE,
                    LOC("entity-bad1.xml", 9, 1),
                    .info = XMLERR_NOTE,
                    .msg = "This is the location of the previous definition",
            ),
            EV(MESSAGE,
                    LOC("entity-bad1.xml", 11, 14),
                    .info = XMLERR(ERROR, XML, P_EntityDecl),
                    .msg = "Expect whitespace here",
            ),
            EV(MESSAGE,
                    LOC("entity-bad1.xml", 12, 28),
                    .info = XMLERR(ERROR, XML, PREDEFINED_ENTITY),
                    .msg = "Predefined entity may only be declared as internal entity",
            ),
            EV(MESSAGE,
                    LOC("entity-bad1.xml", 13, 33),
                    .info = XMLERR(ERROR, XML, P_EntityDecl),
                    .msg = "Expected string: 'NDATA'",
            ),
            EV(MESSAGE,
                    LOC("entity-bad1.xml", 14, 36),
                    .info = XMLERR(ERROR, XML, P_EntityDecl),
                    .msg = "Expect whitespace here",
            ),
            EV(MESSAGE,
                    LOC("entity-bad1.xml", 15, 37),
                    .info = XMLERR(ERROR, XML, P_EntityDecl),
                    .msg = "Expect notation name here",
            ),
            EV(MESSAGE,
                    LOC("entity-bad1.xml", 16, 1),
                    .info = XMLERR(ERROR, XML, VC_NOTATION_DECLARED),
                    .msg = "Notation must be declared",
            ),
            EV(MESSAGE,
                    LOC("entity-bad1.xml", 17, 1),
                    .info = XMLERR(WARN, XML, ENTITY_REDECLARED),
                    .msg = "Redefinition of an entity",
            ),
            EV(MESSAGE,
                    LOC("entity-bad1.xml", 3, 1),
                    .info = XMLERR_NOTE,
                    .msg = "This is the location of the previous definition",
            ),
            EV(MESSAGE,
                    LOC("entity-bad1.xml", 18, 1),
                    .info = XMLERR(WARN, XML, ENTITY_REDECLARED),
                    .msg = "Redefinition of an entity",
            ),
            EV(MESSAGE,
                    LOC("entity-bad1.xml", 4, 1),
                    .info = XMLERR_NOTE,
                    .msg = "This is the location of the previous definition",
            ),
            EV(MESSAGE,
                    LOC("entity-bad1.xml", 19, 20),
                    .info = XMLERR(ERROR, XML, P_EntityValue),
                    .msg = "Quoted literal expected",
            ),
            EV(MESSAGE,
                    LOC("entity-bad1.xml", 20, 1),
                    .info = XMLERR(ERROR, XML, PREDEFINED_ENTITY),
                    .msg = "Incompatible redefinition of a predefined entity",
            ),
            EV(MESSAGE,
                    LOC("entity-bad1.xml", 21, 20),
                    .info = XMLERR(ERROR, XML, P_ExternalID),
                    .msg = "Expect whitespace here",
            ),
            EV(MESSAGE,
                    LOC("entity-bad1.xml", 22, 20),
                    .info = XMLERR(ERROR, XML, P_EntityDecl),
                    .msg = "Expected string: '>'",
            ),
            E0(DTD_END_INTERNAL,
                    LOC("entity-bad1.xml", 23, 1)
            ),
            E0(DTD_END,
                    LOC("entity-bad1.xml", 23, 3)
            ),
            EV(STAG,
                    LOC("entity-bad1.xml", 24, 1),
                    .name = TOK("a"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("entity-bad1.xml", 24, 4),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("first"),
            ),
            EV(ENTITY_PARSE_END,
                    LOC("entity-bad1.xml", 24, 4),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("first"),
            ),
            EV(TEXT,
                    LOC("entity-bad1.xml", 24, 4),
                    .text = TOK("aaa"),
                    .ws = false,
            ),
            EV(ETAG,
                    LOC("entity-bad1.xml", 24, 11),
                    .name = TOK("a"),
            ),
            END,
        },
    },
#if 0 // TBD
    {
        TC("Malformed entity declaration #2"),
        .input = "entity-bad2.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(DTD_BEGIN,
                    LOC("entity-bad2.xml", 1, 1),
                    .root = TOK("a"),
            ),
            E0(DTD_END_INTERNAL,
                    LOC("entity-bad2.xml", 1, 1)
            ),
            EV(ENTITY_DEF,
                    LOC("entity-bad2.xml", 2, 1),
                    .name = TOK("a"),
            ),
            EV(TEXT,
                    LOC("entity-bad2.xml", 2, 12),
                    .text = TOK("aa &b; aa"),
                    .ws = false,
            ),
            EV(ENTITY_DEF,
                    LOC("entity-bad2.xml", 3, 1),
                    .name = TOK("b"),
            ),
            EV(TEXT,
                    LOC("entity-bad2.xml", 3, 12),
                    .text = TOK("bb &c; bb"),
                    .ws = false,
            ),
            EV(ENTITY_DEF,
                    LOC("entity-bad2.xml", 4, 1),
                    .name = TOK("c"),
            ),
            EV(TEXT,
                    LOC("entity-bad2.xml", 4, 12),
                    .text = TOK("cc &a; cc"),
                    .ws = false,
            ),
            E0(DTD_END,
                    LOC("entity-bad2.xml", 5, 3)
            ),
            EV(STAG,
                    LOC("entity-bad2.xml", 6, 1),
                    .name = TOK("a"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("entity-bad2.xml", 6, 4),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("a"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("entity(a)", 1, 4),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("b"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("entity(b)", 1, 4),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("c"),
            ),
            EV(MESSAGE,
                    LOC("entity(c)", 1, 4),
                    .info = XMLERR(ERROR, XML, WFC_NO_RECURSION),
                    .msg = "Parsed entity may not contain a recursive reference to itself",
            ),
            EV(MESSAGE,
                    LOC("entity-bad2.xml", 6, 4),
                    .info = XMLERR_NOTE,
                    .msg = "This is the location of previous inclusion",
            ),
            EV(ENTITY_PARSE_END,
                    LOC("entity(b)", 1, 4),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("c"),
            ),
            EV(ENTITY_PARSE_END,
                    LOC("entity(a)", 1, 4),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("b"),
            ),
            EV(ENTITY_PARSE_END,
                    LOC("entity-bad2.xml", 6, 4),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("a"),
            ),
            EV(TEXT,
                    LOC("entity-bad2.xml", 6, 4),
                    .text = TOK("aa bb cc  cc bb aa"),
                    .ws = false,
            ),
            EV(ETAG,
                    LOC("entity-bad2.xml", 6, 7),
                    .name = TOK("a"),
            ),
            END,
        },
    },
    {
        TC("Malformed entity declaration #3"),
        .input = "entity-bad3.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(DTD_BEGIN,
                    LOC("entity-bad3.xml", 1, 1),
                    .root = TOK("a"),
            ),
            E0(DTD_END_INTERNAL,
                    LOC("entity-bad3.xml", 1, 1)
            ),
            EV(ENTITY_DEF,
                    LOC("entity-bad3.xml", 2, 1),
                    .name = TOK("a"),
            ),
            EV(TEXT,
                    LOC("entity-bad3.xml", 2, 12),
                    .text = TOK("aa &b; aa"),
                    .ws = false,
            ),
            EV(ENTITY_DEF,
                    LOC("entity-bad3.xml", 3, 1),
                    .name = TOK("b"),
            ),
            EV(TEXT,
                    LOC("entity-bad3.xml", 3, 12),
                    .text = TOK("bb &c; bb"),
                    .ws = false,
            ),
            EV(ENTITY_DEF,
                    LOC("entity-bad3.xml", 4, 1),
                    .name = TOK("c"),
            ),
            EV(TEXT,
                    LOC("entity-bad3.xml", 4, 12),
                    .text = TOK("cc &a; cc"),
                    .ws = false,
            ),
            E0(DTD_END,
                    LOC("entity-bad3.xml", 5, 3)
            ),
            EV(STAG,
                    LOC("entity-bad3.xml", 6, 1),
                    .name = TOK("a"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("entity-bad3.xml", 6, 4),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("a"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("entity(a)", 1, 4),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("b"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("entity(b)", 1, 4),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("c"),
            ),
            EV(MESSAGE,
                    LOC("entity(c)", 1, 4),
                    .info = XMLERR(ERROR, XML, WFC_NO_RECURSION),
                    .msg = "Parsed entity may not contain a recursive reference to itself",
            ),
            EV(MESSAGE,
                    LOC("entity-bad3.xml", 6, 4),
                    .info = XMLERR_NOTE,
                    .msg = "This is the location of previous inclusion",
            ),
            EV(ENTITY_PARSE_END,
                    LOC("entity(b)", 1, 4),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("c"),
            ),
            EV(ENTITY_PARSE_END,
                    LOC("entity(a)", 1, 4),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("b"),
            ),
            EV(ENTITY_PARSE_END,
                    LOC("entity-bad3.xml", 6, 4),
                    .type = XML_READER_REF_INTERNAL,
                    .name = TOK("a"),
            ),
            EV(TEXT,
                    LOC("entity-bad3.xml", 6, 4),
                    .text = TOK("aa bb cc  cc bb aa"),
                    .ws = false,
            ),
            EV(ETAG,
                    LOC("entity-bad3.xml", 6, 7),
                    .name = TOK("a"),
            ),
            END,
        },
    },
    {
        TC("Malformed entity declaration #4"),
        .input = "entity-bad4.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(DTD_BEGIN,
                    LOC("entity-bad4.xml", 1, 1),
                    .root = TOK("a"),
            ),
            E0(DTD_END_INTERNAL,
                    LOC("entity-bad4.xml", 1, 1)
            ),
            EV(NOTATION_DEF,
                    LOC("entity-bad4.xml", 2, 1),
                    .name = TOK("N"),
            ),
            EV(SYSID,
                    LOC("entity-bad4.xml", 2, 21),
                    .system_id = TOK("foo"),
            ),
            EV(ENTITY_DEF,
                    LOC("entity-bad4.xml", 3, 1),
                    .name = TOK("gt"),
            ),
            EV(MESSAGE,
                    LOC("entity-bad4.xml", 3, 13),
                    .info = XMLERR(ERROR, XML, PREDEFINED_ENTITY),
                    .msg = "Incompatible redefinition of a predefined entity",
            ),
            EV(ENTITY_DEF,
                    LOC("entity-bad4.xml", 4, 1),
                    .name = TOK("amp"),
            ),
            EV(TEXT,
                    LOC("entity-bad4.xml", 4, 14),
                    .text = TOK("&x"),
                    .ws = false,
            ),
            EV(MESSAGE,
                    LOC("entity-bad4.xml", 4, 14),
                    .info = XMLERR(ERROR, XML, PREDEFINED_ENTITY),
                    .msg = "Incompatible redefinition of a predefined entity",
            ),
            EV(ENTITY_DEF,
                    LOC("entity-bad4.xml", 5, 1),
                    .name = TOK("unp"),
            ),
            EV(SYSID,
                    LOC("entity-bad4.xml", 5, 21),
                    .system_id = TOK("bar"),
            ),
            EV(NDATA,
                    LOC("entity-bad4.xml", 5, 33),
                    .ndata = TOK("N"),
                    .nsystem_id = TOK("foo"),
            ),
            EV(MESSAGE,
                    LOC("entity-bad4.xml", 6, 1),
                    .info = XMLERR(WARN, XML, ENTITY_REDECLARED),
                    .msg = "Redefinition of an entity",
            ),
            EV(MESSAGE,
                    LOC("entity-bad4.xml", 5, 1),
                    .info = XMLERR_NOTE,
                    .msg = "This is the location of the previous definition",
            ),
            EV(ENTITY_DEF,
                    LOC("entity-bad4.xml", 6, 1),
                    .name = TOK("unp"),
            ),
            EV(SYSID,
                    LOC("entity-bad4.xml", 6, 21),
                    .system_id = TOK("baz"),
            ),
            EV(NDATA,
                    LOC("entity-bad4.xml", 6, 33),
                    .ndata = TOK("N"),
                    .nsystem_id = TOK("foo"),
            ),
            EV(ENTITY_DEF,
                    LOC("entity-bad4.xml", 7, 1),
                    .name = TOK("xxx"),
            ),
            EV(SYSID,
                    LOC("entity-bad4.xml", 7, 21),
                    .system_id = TOK("zzz"),
            ),
            E0(DTD_END,
                    LOC("entity-bad4.xml", 8, 3)
            ),
            EV(STAG,
                    LOC("entity-bad4.xml", 9, 1),
                    .name = TOK("a"),
            ),
            END,
        },
    },
    {
        TC("Malformed external ID"),
        .input = "external-id.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(DTD_BEGIN,
                    LOC("external-id.xml", 1, 1),
                    .root = TOK("a"),
            ),
            E0(DTD_END_INTERNAL,
                    LOC("external-id.xml", 1, 1)
            ),
            EV(ENTITY_DEF,
                    LOC("external-id.xml", 2, 1),
                    .name = TOK("a1"),
            ),
            EV(MESSAGE,
                    LOC("external-id.xml", 2, 13),
                    .info = XMLERR(ERROR, XML, P_ExternalID),
                    .msg = "Expected string: 'SYSTEM'",
            ),
            EV(ENTITY_DEF,
                    LOC("external-id.xml", 3, 1),
                    .name = TOK("a2"),
            ),
            EV(MESSAGE,
                    LOC("external-id.xml", 3, 13),
                    .info = XMLERR(ERROR, XML, P_ExternalID),
                    .msg = "Expected string: 'PUBLIC'",
            ),
            EV(ENTITY_DEF,
                    LOC("external-id.xml", 4, 1),
                    .name = TOK("a3"),
            ),
            EV(PUBID,
                    LOC("external-id.xml", 4, 20),
                    .public_id = TOK("111"),
            ),
            EV(SYSID,
                    LOC("external-id.xml", 4, 26),
                    .system_id = TOK("222"),
            ),
            EV(MESSAGE,
                    LOC("external-id.xml", 5, 1),
                    .info = XMLERR(WARN, XML, ENTITY_REDECLARED),
                    .msg = "Redefinition of an entity",
            ),
            EV(MESSAGE,
                    LOC("external-id.xml", 4, 1),
                    .info = XMLERR_NOTE,
                    .msg = "This is the location of the previous definition",
            ),
            EV(ENTITY_DEF,
                    LOC("external-id.xml", 5, 1),
                    .name = TOK("a3"),
            ),
            EV(PUBID,
                    LOC("external-id.xml", 5, 20),
                    .public_id = TOK("333"),
            ),
            EV(SYSID,
                    LOC("external-id.xml", 5, 26),
                    .system_id = TOK("444"),
            ),
            EV(ENTITY_DEF,
                    LOC("external-id.xml", 6, 1),
                    .name = TOK("a4"),
            ),
            EV(MESSAGE,
                    LOC("external-id.xml", 6, 20),
                    .info = XMLERR(ERROR, XML, P_SystemLiteral),
                    .msg = "Quoted literal expected",
            ),
            EV(NOTATION_DEF,
                    LOC("external-id.xml", 7, 1),
                    .name = TOK("x1"),
            ),
            EV(PUBID,
                    LOC("external-id.xml", 7, 22),
                    .public_id = TOK("bar"),
            ),
            EV(NOTATION_DEF,
                    LOC("external-id.xml", 8, 1),
                    .name = TOK("x2"),
            ),
            EV(MESSAGE,
                    LOC("external-id.xml", 8, 22),
                    .info = XMLERR(ERROR, XML, P_PubidLiteral),
                    .msg = "Quoted literal expected",
            ),
            EV(NOTATION_DEF,
                    LOC("external-id.xml", 9, 1),
                    .name = TOK("x3"),
            ),
            EV(PUBID,
                    LOC("external-id.xml", 9, 22),
                    .public_id = TOK("zoot"),
            ),
            EV(MESSAGE,
                    LOC("external-id.xml", 9, 29),
                    .info = XMLERR(ERROR, XML, P_NotationDecl),
                    .msg = "Expected string: '>'",
            ),
            EV(NOTATION_DEF,
                    LOC("external-id.xml", 10, 1),
                    .name = TOK("x4"),
            ),
            EV(PUBID,
                    LOC("external-id.xml", 10, 22),
                    .public_id = TOK("zoot"),
            ),
            EV(SYSID,
                    LOC("external-id.xml", 10, 29),
                    .system_id = TOK("zhab"),
            ),
            E0(DTD_END,
                    LOC("external-id.xml", 11, 3)
            ),
            EV(MESSAGE,
                    LOC("external-id.xml", 12, 1),
                    .info = XMLERR(ERROR, XML, P_document),
                    .msg = "No root element",
            ),
            END,
        },
    },
    {
        TC("Coverage for normalization checking while backtracking in CDATA parser"),
        .input = "cdata-normchecking.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(XMLDECL,
                    LOC("cdata-normchecking.xml", 1, 1),
                    .encoding = NULL,
                    .standalone = XML_INFO_STANDALONE_NO_VALUE,
                    .version = XML_INFO_VERSION_1_1,
            ),
            EV(STAG,
                    LOC("cdata-normchecking.xml", 2, 1),
                    .name = TOK("a"),
            ),
            EV(CDSECT,
                    LOC("cdata-normchecking.xml", 2, 4),
                    .text = TOK("abc]]def]ghi"),
                    .ws = false,
            ),
            EV(ETAG,
                    LOC("cdata-normchecking.xml", 2, 28),
                    .name = TOK("a"),
            ),
            END,
        },
    },
    {
        TC("Character references evaluating to codepoint beyond defined Unicode range"),
        .input = "charref-toobig.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(STAG,
                    LOC("charref-toobig.xml", 1, 1),
                    .name = TOK("a"),
            ),
            EV(MESSAGE,
                    LOC("charref-toobig.xml", 1, 4),
                    .info = XMLERR(ERROR, XML, P_CharRef),
                    .msg = "Character reference did not evaluate to a valid UCS-4 code point",
            ),
            EV(MESSAGE,
                    LOC("charref-toobig.xml", 1, 14),
                    .info = XMLERR(ERROR, XML, P_CharRef),
                    .msg = "Character reference did not evaluate to a valid UCS-4 code point",
            ),
            EV(MESSAGE,
                    LOC("charref-toobig.xml", 1, 24),
                    .info = XMLERR(ERROR, XML, P_CharRef),
                    .msg = "Character reference did not evaluate to a valid UCS-4 code point",
            ),
            EV(MESSAGE,
                    LOC("charref-toobig.xml", 1, 34),
                    .info = XMLERR(ERROR, XML, P_CharRef),
                    .msg = "Character reference did not evaluate to a valid UCS-4 code point",
            ),
            EV(ETAG,
                    LOC("charref-toobig.xml", 1, 44),
                    .name = TOK("a"),
            ),
            END,
        },
    },
    {
        TC("Malformed parameter/character references"),
        .input = "entity-bad5.xml",
        .events = (const xml_reader_cbparam_t[]){
            EV(DTD_BEGIN,
                    LOC("entity-bad5.xml", 1, 1),
                    .root = TOK("a"),
            ),
            E0(DTD_END_INTERNAL,
                    LOC("entity-bad5.xml", 1, 1)
            ),
            EV(MESSAGE,
                    LOC("entity-bad5.xml", 2, 1),
                    .info = XMLERR(ERROR, XML, P_PEReference),
                    .msg = "Malformed parameter entity reference",
            ),
            EV(MESSAGE,
                    LOC("entity-bad5.xml", 2, 2),
                    .info = XMLERR(ERROR, XML, P_DeclSep),
                    .msg = "Invalid content in DTD",
            ),
            EV(ENTITY_DEF,
                    LOC("entity-bad5.xml", 3, 1),
                    .name = TOK("x"),
            ),
            EV(SYSID,
                    LOC("entity-bad5.xml", 3, 19),
                    .system_id = TOK("entity-bad5-2.xml"),
            ),
            E0(DTD_END,
                    LOC("entity-bad5.xml", 4, 3)
            ),
            EV(STAG,
                    LOC("entity-bad5.xml", 5, 1),
                    .name = TOK("a"),
            ),
            EV(ENTITY_PARSE_START,
                    LOC("entity-bad5.xml", 5, 4),
                    .type = XML_READER_REF_EXTERNAL,
                    .name = TOK("x"),
                    .system_id = TOK("entity-bad5-2.xml"),
            ),
            EV(MESSAGE,
                    LOC("entity-bad5-2.xml", 1, 1),
                    .info = XMLERR(ERROR, XML, P_CharRef),
                    .msg = "Malformed character reference",
            ),
            EV(ENTITY_PARSE_END,
                    LOC("entity-bad5.xml", 5, 4),
                    .type = XML_READER_REF_EXTERNAL,
                    .name = TOK("x"),
                    .system_id = TOK("entity-bad5-2.xml"),
            ),
            EV(ETAG,
                    LOC("entity-bad5.xml", 5, 7),
                    .name = TOK("a"),
            ),
            END,
        },
    },
#endif
};

static const testset_t testsets[] = {
    TEST_SET(run_testcase, "Tests for misc APIs", testcases_api),
    TEST_SET(run_testcase, "Encoding tests", testcases_encoding),
    TEST_SET(run_testcase, "XML/Text declaration tests", testcases_xmldecl),
    TEST_SET(run_testcase, "XML structures", testcases_structure),
};

static const testsuite_t testsuite = TEST_SUITE("Tests for XML reader API", testsets);

